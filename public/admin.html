<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Poker Admin</title>
<link rel="stylesheet" href="/app.css">
<style>
body { background:#0b0d13; color:#e5e7eb; font-family:system-ui,sans-serif; }
.wrap { max-width:600px; margin:0 auto; padding:20px; }
h1 { text-align:center; margin-bottom:20px; }
.row { display:flex; gap:6px; margin-top:10px; }
.btn { padding:6px 12px; border-radius:6px; border:none; cursor:pointer; font-weight:600; background:#22d3ee; color:#000; }
.btn.red { background:#b91c1c; color:#fff; }
.btn.gray { background:#374151; color:#eee; }
input { padding:6px; border-radius:6px; background:#111722; border:1px solid #334155; color:#e5e7eb; flex:1; }
.user-list { margin-top:20px; display:flex; flex-direction:column; gap:8px; }
.user-item { background:#111722; padding:8px; border-radius:8px; border:1px solid #1f2937; display:flex; justify-content:space-between; align-items:center; }
.muted { opacity:.65; }
</style>
</head>
<body>

<div class="wrap">
  <h1>ADMIN PANEL</h1>

  <div class="row">
    <input type="password" id="adminkey" placeholder="x-admin-key">
    <button class="btn" onclick="setKey()">Set</button>
  </div>

  <div class="row">
    <input type="text" id="email" placeholder="email korisnika">
  </div>

  <div class="row">
    <input type="number" id="chips" placeholder="čipovi (+ dodaj, - oduzmi)">
    <button class="btn" onclick="give()">Primijeni</button>
  </div>

  <div class="row">
    <button class="btn gray" onclick="disable(1)">DISABLE</button>
    <button class="btn" onclick="disable(0)">ENABLE</button>
  </div>

  <div id="msg" style="margin-top:10px;color:#22d3ee;"></div>

  <h2 style="margin-top:30px;text-align:center;">Korisnici</h2>
  <div id="users" class="user-list">Loading...</div>
</div>

<script>
let KEY = "";

function setKey(){
  KEY = document.getElementById("adminkey").value.trim();
  loadUsers();
}

async function give(){
  const email = document.getElementById("email").value.trim();
  const amount = parseInt(document.getElementById("chips").value||"0",10);
  if(!email || !amount) return msg("Unesi email i iznos.");

  const r = await fetch("/api/admin/chips",{
    method:"POST",
    headers:{ "Content-Type":"application/json", "x-admin-key":KEY },
    body:JSON.stringify({email,amount})
  }).then(r=>r.json());

  if(r.ok){ msg("Uspješno."); loadUsers(); }
  else msg("Greška: "+(r.error||""));
}

async function disable(flag){
  const email = document.getElementById("email").value.trim();
  if(!email) return msg("Unesi email.");

  const r = await fetch("/api/admin/disable",{
    method:"POST",
    headers:{ "Content-Type":"application/json", "x-admin-key":KEY },
    body:JSON.stringify({email,flag})
  }).then(r=>r.json());

  if(r.ok){ msg(flag? "Korisnik DISABLED":"Korisnik ENABLED"); loadUsers(); }
  else msg("Greška.");
}

function msg(t){ document.getElementById("msg").textContent=t; }

async function loadUsers(){
  const r = await fetch("/api/tables"); // samo da provjerimo server
  const all = await fetch("/api/tables").catch(()=>null);

  // ali korisnike vadimo iz baze preko stola:
  // zato radimo trik -> izvući sve seat korisnike
  // jednostavnije: napravimo listu unutar servera kasnije.
  // Za sada listamo sve korisnike:
  const users = await fetch("/data", {method:"POST"}).catch(()=>null);

  // Pošto nemamo api/listUsers endpoint — pravimo ga sada:
  const u = await fetch("/api/debug/users").catch(()=>null);
}

// Pošto trebamo listu korisnika → odmah dodajemo mali endpoint:
fetch("/api/debug/users").then(async r=>{
  if(!r.ok) return document.getElementById("users").innerHTML="Nema endpoint /api/debug/users — reci 'daj listUsers' i napravim odmah.";
  const data = await r.json();
  if(!data.ok) return;
  renderUsers(data.users);
});

function renderUsers(list){
  const box = document.getElementById("users");
  box.innerHTML="";
  list.forEach(u=>{
    const div=document.createElement("div");
    div.className="user-item";
    div.innerHTML=`<div>${u.email}</div><div class="muted">${u.balance} čipova</div>`;
    div.onclick=()=>{ document.getElementById("email").value=u.email; };
    box.appendChild(div);
  });
}
</script>

</body>
</html>
