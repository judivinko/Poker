

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ARTEFACT • Admin</title>
  <link rel="stylesheet" href="/app.css" />
  <style>
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 900px){.grid2{grid-template-columns:1fr}}
    .list{background:#0b1220;border:1px solid #233047;border-radius:10px;padding:12px;white-space:pre-wrap}
    .rowx{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .muted{opacity:.85}
    .tag{font-size:11px;padding:2px 6px;border-radius:6px;background:#1f2937}
    .tag.red{background:#3b1113;color:#fecaca}
    .tag.green{background:#0f2e1b;color:#bbf7d0}
    .search{width:100%;padding:8px;border-radius:8px;border:1px solid #233047;background:#0b1220;color:#e2e8f0}
    .user-row{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:6px 8px;border-radius:8px}
    .user-row:hover{background:#0f172a}

    .codes-table{width:100%;border-collapse:collapse}
    .codes-table th,.codes-table td{padding:8px 10px;border-bottom:1px solid #233047;text-align:left}
    .codes-table th{color:#94a3b8;font-weight:600;text-transform:uppercase;font-size:12px;letter-spacing:.4px}
    .codes-table input{background:#0b1220;border:1px solid #233047;border-radius:8px;padding:8px 10px;color:#e2e8f0;width:100%}
    .codes-row-actions{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body class="admin">

  <!-- Header -->
  <header class="header">
    <div class="brand">ARTEFACT • Admin</div>
    <div id="who" class="muted">Status: unknown</div>
  </header>

  <main class="container">
    <!-- Admin Key -->
    <section class="card">
      <div class="label">Admin</div>
      <div class="rowx">
        <input id="admin-key" type="password" placeholder="x-admin-key" />
        <button id="btn-key-set">Set</button>
        <button id="btn-key-clear" class="secondary">Clear</button>
        <label class="rowx">
          <input type="checkbox" id="key-lock" />
          <span>Lock key</span>
        </label>
        <label class="rowx">
          <input type="checkbox" id="key-remember" />
          <span>Remember in this browser</span>
        </label>
        <span id="key-msg" class="muted"></span>
      </div>
    </section>

    <section class="grid2">
      <!-- Controls -->
      <div class="card">
        <div class="label">Controls</div>

        <div class="muted" id="sel-user-label">Selected user: —</div>

        <div class="rowx" style="margin-top:8px">
          <input id="gold-amount" type="number" min="-999999" step="1" placeholder="Gold amount (1g = 100s)" />
          <button id="btn-give">+ Give</button>
          <button id="btn-take" class="secondary">– Take</button>
        </div>

        <div class="rowx" style="margin-top:8px">
          <button id="btn-disable" class="danger">Disable account</button>
          <button id="btn-enable" class="secondary">Enable account</button>
        </div>

        <div id="ops-msg" class="muted" style="margin-top:6px"></div>

        <hr style="border:none;border-top:1px solid #233047;margin:10px 0" />

        <div class="label">Artefact Bonus Gold</div>
        <div class="rowx" style="margin-top:8px">
          <input id="bonus-gold" type="number" min="0" step="1" placeholder="Bonus gold" />
          <button id="btn-set-bonus">Set</button>
        </div>
        <div id="bonus-msg" class="muted" style="margin-top:6px"></div>

        <hr style="border:none;border-top:1px solid #233047;margin:12px 0" />
        <div class="label">Bonus Codes</div>
        <div class="muted" style="margin-top:4px">Unesi do 5 kodova. Svaki red ima svoj “Save X”.</div>

        <div class="rowx" style="margin-top:8px;justify-content:space-between">
          <button id="btn-codes-reload" class="secondary">Reload</button>
          <button id="btn-codes-save-all" class="secondary">Save all</button>
        </div>

        <div style="overflow:auto;margin-top:8px">
          <table class="codes-table">
            <thead>
              <tr>
                <th style="width:40%">Bonus code</th>
                <th style="width:20%">Percent (%)</th>
                <th style="width:25%">Total used (gold)</th>
                <th style="width:15%">Action</th>
              </tr>
            </thead>
            <tbody id="codes-tbody">
              <tr>
                <td><input id="bonus-code-0" placeholder="e.g. WINTER5"></td>
                <td><input id="bonus-percent-0" type="number" min="0" max="100" step="1" placeholder="0"></td>
                <td><input id="bonus-used-0" value="0" disabled></td>
                <td><div class="codes-row-actions"><button id="btn-save-1" class="secondary">Save 1</button></div></td>
              </tr>
              <tr>
                <td><input id="bonus-code-1" placeholder="e.g. SPRING10"></td>
                <td><input id="bonus-percent-1" type="number" min="0" max="100" step="1" placeholder="0"></td>
                <td><input id="bonus-used-1" value="0" disabled></td>
                <td><div class="codes-row-actions"><button id="btn-save-2" class="secondary">Save 2</button></div></td>
              </tr>
              <tr>
                <td><input id="bonus-code-2" placeholder="e.g. SUMMER3"></td>
                <td><input id="bonus-percent-2" type="number" min="0" max="100" step="1" placeholder="0"></td>
                <td><input id="bonus-used-2" value="0" disabled></td>
                <td><div class="codes-row-actions"><button id="btn-save-3" class="secondary">Save 3</button></div></td>
              </tr>
              <tr>
                <td><input id="bonus-code-3" placeholder="e.g. FALL7"></td>
                <td><input id="bonus-percent-3" type="number" min="0" max="100" step="1" placeholder="0"></td>
                <td><input id="bonus-used-3" value="0" disabled></td>
                <td><div class="codes-row-actions"><button id="btn-save-4" class="secondary">Save 4</button></div></td>
              </tr>
              <tr>
                <td><input id="bonus-code-4" placeholder="e.g. VIP15"></td>
                <td><input id="bonus-percent-4" type="number" min="0" max="100" step="1" placeholder="0"></td>
                <td><input id="bonus-used-4" value="0" disabled></td>
                <td><div class="codes-row-actions"><button id="btn-save-5" class="secondary">Save 5</button></div></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div id="codes-msg" class="muted" style="margin-top:6px"></div>
      </div>

      <!-- Users + Inventory -->
      <div class="card">
        <div class="rowx" style="justify-content:space-between;">
          <div class="label">Users (active first, A–Z)</div>
          <button id="btn-refresh-users" class="secondary">Refresh</button>
        </div>

        <input id="search" class="search" placeholder="Search email…" />
        <div id="users" class="list" style="margin-top:8px;max-height:320px;overflow:auto;">—</div>

        <div class="card" style="margin-top:12px;">
          <div class="rowx" style="justify-content:space-between;">
            <div class="label">Inventory of selected user</div>
            <button id="btn-refresh-inv" class="secondary">Reload</button>
          </div>
          <div id="inv" class="list">Select a user from the list →</div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Helpers
    const $ = s => document.querySelector(s);
    let ADMIN_KEY = "", LOCKED = false, REMEMBER = false;
    let users = [], selected = null;

    function msg(sel, text, ok=true){
      const e=$(sel); if(!e) return;
      e.textContent=text; e.className = ok ? "muted success" : "muted danger";
    }
    function setWho(text){ const e=$("#who"); if(e) e.textContent = text; }

    function loadPrefs(){
      ADMIN_KEY = localStorage.getItem("admin.key") || "";
      LOCKED = localStorage.getItem("admin.lock") === "1";
      REMEMBER = localStorage.getItem("admin.remember") === "1";
      $("#admin-key").value = ADMIN_KEY;
      $("#key-lock").checked = LOCKED;
      $("#key-remember").checked = REMEMBER;
      applyLock();
    }
    function savePrefs(){
      if (REMEMBER) localStorage.setItem("admin.key", ADMIN_KEY);
      else localStorage.removeItem("admin.key");
      localStorage.setItem("admin.lock", LOCKED ? "1" : "0");
      localStorage.setItem("admin.remember", REMEMBER ? "1" : "0");
    }

    // LOCK sada zaključava:
    //   1) polja za ključ (kao i prije),
    //   2) "safe" dugmad (Save 1–5, Save all),
    //   3) INPUT polja bonus kodova (code + percent).
    function applyLock(){
      // 1) postojeće: field i tipke za key
      $("#admin-key").disabled = LOCKED;
      $("#btn-key-set").disabled = LOCKED;
      $("#btn-key-clear").disabled = LOCKED;

      // 2) safe dugmad u Bonus Codes sekciji
      const safeButtons = [
        "btn-save-1","btn-save-2","btn-save-3","btn-save-4","btn-save-5",
        "btn-codes-save-all"
      ];
      safeButtons.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.disabled = LOCKED;
      });

      // 3) input polja (code + percent) – onemogući unos kad je LOCK
      for (let i = 0; i < 5; i++){
        const codeEl = document.getElementById(`bonus-code-${i}`);
        const pctEl  = document.getElementById(`bonus-percent-${i}`);
        if (codeEl) codeEl.disabled = LOCKED;
        if (pctEl)  pctEl.disabled  = LOCKED;
      }
      // "Reload" i "Total used" ostaju kao prije.
    }

    async function api(path, opts={}){
      const headers = { "Content-Type":"application/json", ...(opts.headers||{}) };
      if (ADMIN_KEY) headers["x-admin-key"] = ADMIN_KEY;
      const res = await fetch(path, { credentials:"include", ...opts, headers });
      let data = null; try{ data = await res.json(); }catch{}
      if (!res.ok) throw new Error((data && data.error) || `HTTP ${res.status}`);
      return data;
    }

    async function checkAdmin(){
      try{ await api("/api/admin/ping"); msg("#key-msg","Admin OK",true); }
      catch(e){ msg("#key-msg","Key invalid or missing ("+e.message+")",false); }
    }

    // Users
    function renderUsers(){
      const q = ($("#search").value||"").trim().toLowerCase();
      const box = $("#users"); box.innerHTML = "";
      let list = users.slice();
      list.sort((a,b)=> (a.is_disabled===b.is_disabled ? a.email.localeCompare(b.email) : (a.is_disabled?1:-1)));
      if (q) list = list.filter(u => u.email.toLowerCase().includes(q));
      if (!list.length){ box.textContent="No users."; return; }
      for (const u of list){
        const row = document.createElement("div"); row.className="user-row";
        row.innerHTML = `
          <div>
            <span class="mono">#${u.id}</span>
            <span class="mono">${u.email}</span>
            ${u.is_disabled ? `<span class="tag red">disabled</span>` : `<span class="tag green">active</span>`}
          </div>
          <div class="muted">${u.gold}g ${u.silver}s</div>
        `;
        row.addEventListener("click", ()=> selectUser(u));
        box.appendChild(row);
      }
    }
    async function loadUsers(){
      $("#users").textContent = "Loading…";
      try{ const r = await api("/api/admin/users"); users = r.users||[]; renderUsers(); }
      catch(e){ $("#users").textContent = e.message; }
    }
    function selectUser(u){
      selected = u;
      $("#sel-user-label").textContent = `Selected user: ${u.email} (id ${u.id})`;
      $("#ops-msg").textContent = "";
      loadInventory();
    }
    async function loadInventory(){
      const box = $("#inv");
      if (!selected){ box.textContent="Select a user from the list →"; return; }
      box.textContent="Loading…";
      try{
        const r = await api(`/api/admin/user/${selected.id}/inventory`);
        const lines = [];
        lines.push("ITEMS:");
        if (!(r.items||[]).length) lines.push("(none)");
        (r.items||[]).forEach(it=> lines.push(` • [T${it.tier}] ${it.name} x${it.qty}`));
        lines.push("");
        lines.push("RECIPES:");
        if (!(r.recipes||[]).length) lines.push("(none)");
        (r.recipes||[]).forEach(rc=> lines.push(` • [T${rc.tier}] ${rc.name} x${rc.qty}`));
        box.textContent = lines.join("\n");
      }catch(e){ box.textContent = e.message; }
    }

    // ----------------- Bonus codes -----------------
    function sanitizeCode(raw){
      const s = String(raw||"").trim().toUpperCase();
      return s.replace(/[^A-Z0-9_.-]/g,"").slice(0,32);
    }
    async function loadBonusCodes(){
      try{
        const r = await api("/api/admin/bonus-codes");
        const rows = r?.slots || [];
        for (let i=0;i<5;i++){
          const entry = rows[i] || { code:"", percent:0, total_credited_silver:0 };
          const codeEl = document.getElementById(`bonus-code-${i}`);
          const pctEl  = document.getElementById(`bonus-percent-${i}`);
          const usedEl = document.getElementById(`bonus-used-${i}`);
          if (codeEl) codeEl.value = entry.code || "";
          if (pctEl)  pctEl.value  = Number(entry.percent||0);
          if (usedEl) usedEl.value = Math.floor((entry.total_credited_silver||0)/100);
        }
        msg("#codes-msg", "Loaded.", true);
      }catch(e){
        for (let i=0;i<5;i++){
          const usedEl = document.getElementById(`bonus-used-${i}`);
          if (usedEl) usedEl.value = 0;
        }
        msg("#codes-msg", e.message || "Failed to load.", false);
      }
      // nakon punjenja, primijeni per-row lock stanja
      applyRowLocksFromStorage();
    }
    async function saveBonusRow(i){
      const codeEl = document.getElementById(`bonus-code-${i}`);
      const pctEl  = document.getElementById(`bonus-percent-${i}`);
      const usedEl = document.getElementById(`bonus-used-${i}`);
      const code = sanitizeCode(codeEl?.value || "");
      const percent = Math.max(0, Math.min(100, parseInt(pctEl?.value||"0",10) || 0));
      try{
        const r = await api("/api/admin/bonus-codes", {
          method:"POST",
          body: JSON.stringify({ slot: i+1, code, percent, is_active:true })
        });
        if (usedEl && typeof r.total_credited_silver === "number") {
          usedEl.value = Math.floor(r.total_credited_silver / 100);
        }
        msg("#codes-msg", `Saved row ${i+1}.`, true);
      }catch(e){
        msg("#codes-msg", e.message || `Save row ${i+1} failed.`, false);
      }
    }
    async function saveAllBonusRows(){
      for (let i=0;i<5;i++){ try{ await saveBonusRow(i); }catch{} }
    }

    // ======== NOVO: Per-row LOCK/UNLOCK (bez promjena HTML-a) ========
    const ROW_LOCK_KEY = "admin.bonus.rowlocks"; // JSON mapa: {"0":true,...}
    function getRowLocks(){
      try { return JSON.parse(localStorage.getItem(ROW_LOCK_KEY) || "{}") || {}; } catch { return {}; }
    }
    function setRowLocks(map){
      try { localStorage.setItem(ROW_LOCK_KEY, JSON.stringify(map||{})); } catch {}
    }
    function isRowLocked(i){ return !!getRowLocks()[i]; }
    function setRowLocked(i, locked){
      const map = getRowLocks(); map[i] = !!locked; setRowLocks(map);
      const codeEl = document.getElementById(`bonus-code-${i}`);
      const pctEl  = document.getElementById(`bonus-percent-${i}`);
      const btn    = document.getElementById(`btn-save-${i+1}`);
      if (codeEl) codeEl.disabled = locked;
      if (pctEl)  pctEl.disabled  = locked;
      if (btn){
        const base = `Save ${i+1}`;
        btn.textContent = locked ? `${base} 🔒` : base;
        btn.classList.toggle("muted", locked);
        btn.style.cursor = locked ? "not-allowed" : "";
      }
      // osvježi i Save all vizual
      updateSaveAllVisual();
    }
    function applyRowLocksFromStorage(){ for (let i=0;i<5;i++) setRowLocked(i, isRowLocked(i)); }
    function toggleRowLock(i){ setRowLocked(i, !isRowLocked(i)); }
    function setAllRowLocks(locked){ for (let i=0;i<5;i++) setRowLocked(i, !!locked); }
    function toggleAllRowLocks(){
      let anyUnlocked=false; for (let i=0;i<5;i++) if (!isRowLocked(i)) { anyUnlocked=true; break; }
      setAllRowLocks(anyUnlocked); // ako ima otključanih -> zaključa sve; inače otključa sve
    }
    function updateSaveAllVisual(){
      const btnAll = document.getElementById("btn-codes-save-all");
      if (!btnAll) return;
      let allLocked = true; for (let i=0;i<5;i++) if (!isRowLocked(i)) { allLocked=false; break; }
      btnAll.textContent = allLocked ? "Save all 🔒" : "Save all";
      btnAll.classList.toggle("muted", allLocked);
      btnAll.style.cursor = allLocked ? "not-allowed" : "";
    }

    // Events
    $("#btn-key-set").addEventListener("click", async ()=>{
      ADMIN_KEY = $("#admin-key").value.trim();
      REMEMBER = $("#key-remember").checked;
      LOCKED = $("#key-lock").checked;
      savePrefs(); applyLock();
      await checkAdmin(); await loadUsers(); await loadBonusCodes();
    });
    $("#btn-key-clear").addEventListener("click", ()=>{ ADMIN_KEY=""; savePrefs(); applyLock(); msg("#key-msg","Cleared."); });
    $("#key-lock").addEventListener("change", ()=>{ LOCKED=$("#key-lock").checked; savePrefs(); applyLock(); });
    $("#key-remember").addEventListener("change", ()=>{ REMEMBER=$("#key-remember").checked; savePrefs(); });

    $("#btn-refresh-users").addEventListener("click", loadUsers);
    $("#btn-refresh-inv").addEventListener("click", loadInventory);
    $("#search").addEventListener("input", renderUsers);

    $("#btn-give").addEventListener("click", ()=> changeGold(+1));
    $("#btn-take").addEventListener("click", ()=> changeGold(-1));
    $("#btn-disable").addEventListener("click", ()=> setDisabled(true));
    $("#btn-enable").addEventListener("click", ()=> setDisabled(false));
    $("#btn-set-bonus").addEventListener("click", setArtefactBonusGold);

    document.getElementById("btn-codes-reload").addEventListener("click", loadBonusCodes);

    // Save all:
    (function wireSaveAll(){
      const btnAll = document.getElementById("btn-codes-save-all");
      if (!btnAll) return;
      updateSaveAllVisual();
      btnAll.addEventListener("click", async (ev) => {
        ev.preventDefault();
        if (ev.shiftKey){
          toggleAllRowLocks();
          return;
        }
        // spremi samo otključane redove
        for (let i=0;i<5;i++){ if (!isRowLocked(i)) { try{ await saveBonusRow(i); }catch{} } }
        msg("#codes-msg","Saved all (locked rows skipped).", true);
      });
    })();

    // Save 1..5: obični klik = Save; Shift+klik = Lock/Unlock tog reda
    ["1","2","3","4","5"].forEach((n, i) => {
      const btn = document.getElementById(`btn-save-${n}`);
      if (btn) {
        btn.addEventListener("click", async (ev) => {
          ev.preventDefault();
          if (ev.shiftKey){
            toggleRowLock(i);
            return;
          }
          if (isRowLocked(i)){
            msg("#codes-msg", `Row ${i+1} is locked. Hold Shift and click to unlock.`, false);
            return;
          }
          await saveBonusRow(i);
        });
      }
    });

    // Init
    loadPrefs();
    (async ()=>{
      try{
        const me = await fetch("/api/me", {credentials:"include"}).then(r=>r.ok?r.json():null).catch(()=>null);
        if (me && me.user) setWho(`${me.user.email} • ${me.user.is_admin ? "ADMIN" : "USER"} • ${me.user.gold}g ${me.user.silver}s`);
        else setWho("Not logged in (key mode).");
      }catch{ setWho("Not logged in (key mode)."); }
      // primijeni per-row lock stanja odmah
      applyRowLocksFromStorage();
      if (ADMIN_KEY){ await checkAdmin(); await loadUsers(); await loadBonusCodes(); }
    })();

    // Controls helpers
    async function changeGold(sign){
      if (!selected){ msg("#ops-msg","Select a user first.",false); return; }
      const amount = parseInt($("#gold-amount").value || "0", 10) || 0;
      if (amount === 0){ msg("#ops-msg","Enter non-zero gold amount.",false); return; }
      const gold = sign > 0 ? amount : -amount;
      try{
        const r = await api("/api/admin/adjust-balance", {
          method:"POST",
          body: JSON.stringify({ email: selected.email, gold })
        });
        msg("#ops-msg", `New balance: ${Math.floor(r.balance_silver/100)}g ${r.balance_silver%100}s`, true);
        await loadUsers();
        const found = users.find(x => x.id === selected.id);
        if (found) selected = found;
        await loadInventory();
      }catch(e){ msg("#ops-msg", e.message, false); }
    }
    async function setDisabled(flag){
      if (!selected){ msg("#ops-msg","Select a user first.",false); return; }
      try{
        await api("/api/admin/disable-user", {
          method:"POST",
          body: JSON.stringify({ email: selected.email, disabled: flag })
        });
        msg("#ops-msg", flag ? "Account disabled." : "Account enabled.", true);
        await loadUsers();
        const found = users.find(x => x.id === selected.id);
        if (found) selected = found;
        $("#sel-user-label").textContent = `Selected user: ${selected.email} (id ${selected.id})`;
      }catch(e){ msg("#ops-msg", e.message, false); }
    }
    async function setArtefactBonusGold(){
      const bonus_gold = parseInt((document.querySelector("#bonus-gold")?.value || "0"), 10) || 0;
      try{
        const r = await api("/api/admin/set-bonus-gold", {
          method:"POST",
          body: JSON.stringify({ code:"ARTEFACT", bonus_gold })
        });
        msg("#bonus-msg", `Artefact bonus set to ${r.bonus_gold} gold.`, true);
      }catch(e){ msg("#bonus-msg", e.message, false); }
    }
  </script>
</body>
</html>

