<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Poker • SPA</title>
  <!-- Vanjski CSS koji smo već radili -->
  <link rel="stylesheet" href="/css/game.css" />
  <style>
    /* Mini dodatci da sve radi odmah */
    :root{--fg:#e5e7eb;--muted:#94a3b8;--bg:#0b0d13}
    body{background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0}
    .hidden{display:none!important}

    /* Topbar */
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid #202635;background:#0d1220;position:sticky;top:0;z-index:10}
    .brand{font-weight:700;letter-spacing:.6px}
    .right{display:flex;gap:10px;align-items:center}
    .badge{font-size:12px;padding:2px 8px;border:1px solid #2a3246;border-radius:999px;color:#cbd5e1;background:#0b1220}
    .btn{background:#1f2937;border:1px solid #374151;color:#e5e7eb;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:#2563eb;border-color:#1d4ed8}
    .btn.secondary{background:#111827;border-color:#253146}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .link{color:#93c5fd;cursor:pointer}

    /* Layout sekcija */
    .page{max-width:1000px;margin:0 auto;padding:16px}
    .card{background:#0b1220;border:1px solid #233047;border-radius:12px;padding:14px;margin:12px 0}

    /* Auth forms */
    .tabs{display:flex;gap:8px;margin-bottom:10px}
    .tabs .tab{padding:8px 12px;border-radius:10px;border:1px solid #233047;background:#0e1626;cursor:pointer}
    .tabs .tab.active{background:#1f2937}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:6px;flex:1 1 220px}
    .field input{padding:10px;border-radius:10px;border:1px solid #233047;background:#0b1220;color:#e5e7eb}
    .muted{color:#9aa8bf}

    /* Wrap i Table su u /css/game.css – samo osiguramo center na mobu */
    .wrap{padding:16px}

    /* Nick/stack overlay tweak */
    .seat .nick,.seat .stack{pointer-events:none}

    /* Status poruke */
    #toast{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);background:#0b1220;border:1px solid #233047;border-radius:10px;padding:10px 12px;color:#dbe3f4;display:none}
    #toast.show{display:block}
  </style>
</head>
<body>

  <!-- ====== TOPBAR ====== -->
  <header class="topbar">
    <div class="brand">POKER</div>
    <div class="right">
      <span id="who" class="badge">Not logged in</span>
      <span id="balance" class="badge">0g 0s</span>
      <button id="btn-logout" class="btn secondary hidden">Logout</button>
    </div>
  </header>

  <main class="page">

    <!-- ====== AUTH (REGISTER / LOGIN) ====== -->
    <section id="page-auth" class="card">
      <div class="tabs">
        <div id="tab-register" class="tab active">Register</div>
        <div id="tab-login" class="tab">Login</div>
      </div>

      <!-- Register -->
      <div id="pane-register">
        <div class="row">
          <div class="field">
            <label>Email</label>
            <input id="reg-email" type="email" placeholder="you@example.com">
          </div>
          <div class="field">
            <label>Password (min 6)</label>
            <input id="reg-pass" type="password" minlength="6" placeholder="••••••">
          </div>
          <div class="field">
            <label>Nickname (prikaz u igri)</label>
            <input id="reg-nick" type="text" placeholder="npr. Sharky">
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="btn-register" class="btn primary">Create account</button>
        </div>
        <div id="msg-register" class="muted" style="margin-top:6px"></div>
      </div>

      <!-- Login -->
      <div id="pane-login" class="hidden">
        <div class="row">
          <div class="field">
            <label>Email</label>
            <input id="login-email" type="email" placeholder="you@example.com">
          </div>
          <div class="field">
            <label>Password</label>
            <input id="login-pass" type="password" placeholder="••••••">
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="btn-login" class="btn primary">Login</button>
        </div>
        <div id="msg-login" class="muted" style="margin-top:6px"></div>
      </div>
    </section>

    <!-- ====== LOBBY ====== -->
    <section id="page-lobby" class="card hidden">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Lobby</h3>
        <button id="btn-refresh-lobby" class="btn secondary">Refresh</button>
      </div>
      <div id="lobby-list" class="muted" style="margin-top:8px">Loading…</div>
    </section>

    <!-- ====== TABLE ====== -->
    <section id="page-table" class="hidden">
      <!-- mini status -->
      <div class="card" style="display:flex;justify-content:space-between;align-items:center">
        <div id="table-status" class="muted">Table • —</div>
        <div class="row">
          <button id="btn-back-lobby" class="btn secondary">← Lobby</button>
          <button id="btn-join" class="btn">Sjedni (buy-in)</button>
          <button id="btn-leave" class="btn secondary">Ustani</button>
        </div>
      </div>

      <!-- ===== TABLE WRAP (keeps aspect and centers) ===== -->
      <main class="wrap">
        <!-- data-seats se postavlja iz stanja (6/9) -->
        <section id="table" class="table" data-seats="9" aria-label="Poker table">
          <!-- background (poker_table.png) je u CSS-u kroz ::before -->

          <!-- ===== BOARD ===== -->
          <div class="board" aria-label="Board cards">
            <div class="card slot flop1"><img src="/card_front_blank.png" alt=""></div>
            <div class="card slot flop2"><img src="/card_front_blank.png" alt=""></div>
            <div class="card slot flop3"><img src="/card_front_blank.png" alt=""></div>
            <div class="card slot turn"><img src="/card_front_blank.png" alt=""></div>
            <div class="card slot river"><img src="/card_front_blank.png" alt=""></div>
          </div>

          <!-- ===== BADGES ===== -->
          <img class="badge btn" src="/dealer_button.png" alt="Dealer" style="display:none">
          <img class="badge sb"  src="/small_blind.png"  alt="Small Blind" style="display:none">
          <img class="badge bb"  src="/big_blind.png"    alt="Big Blind" style="display:none">

          <!-- ===== SEATS (0..8) ===== -->
          <!-- Placeholder i player avatar; player je skriven dok seat nije occupied -->
          <div class="seat seat--0" data-index="0">
            <div class="ring"></div>
            <img class="avatar placeholder" src="/seat_empty.png" alt="Empty seat">
            <img class="avatar player" src="/avatar_1.png" alt="Player" />
            <div class="nick">—</div>
            <div class="stack">—</div>
          </div>
          <div class="seat seat--1" data-index="1">
            <div class="ring"></div>
            <img class="avatar placeholder" src="/seat_empty.png" alt="Empty seat">
            <img class="avatar player" src="/avatar_2.png" alt="Player" />
            <div class="nick">—</div>
            <div class="stack">—</div>
          </div>
          <div class="seat seat--2" data-index="2">
            <div class="ring"></div>
            <img class="avatar placeholder" src="/seat_empty.png" alt="Empty seat">
            <img class="avatar player" src="/avatar_3.png" alt="Player" />
            <div class="nick">—</div>
            <div class="stack">—</div>
          </div>
          <div class="seat seat--3" data-index="3">
            <div class="ring"></div>
            <img class="avatar placeholder" src="/seat_empty.png" alt="Empty seat">
            <img class="avatar player" src="/avatar_4.png" alt="Player" />
            <div class="nick">—</div>
            <div class="stack">—</div>
          </div>
          <div class="seat seat--4" data-index="4">
            <div class="ring"></div>
            <img class="avatar placeholder" src="/seat_empty.png" alt="Empty seat">
            <img class="avatar player" src="/avatar_5.png" alt="Player" />
            <div class="nick">—</div>
            <div class="stack">—</div>
          </div>
          <div class="seat seat--5" data-index="5">
            <div class="ring"></div>
            <img class="avatar placeholder" src="/seat_empty.png" alt="Empty seat">
            <img class="avatar player" src="/avatar_6.png" alt="Player" />
            <div class="nick">—</div>
            <div class="stack">—</div>
          </div>
          <div class="seat seat--6" data-index="6">
            <div class="ring"></div>
            <img class="avatar placeholder" src="/seat_empty.png" alt="Empty seat">
            <img class="avatar player" src="/avatar_7.png" alt="Player" />
            <div class="nick">—</div>
            <div class="stack">—</div>
          </div>
          <div class="seat seat--7" data-index="7">
            <div class="ring"></div>
            <img class="avatar placeholder" src="/seat_empty.png" alt="Empty seat">
            <img class="avatar player" src="/avatar_8.png" alt="Player" />
            <div class="nick">—</div>
            <div class="stack">—</div>
          </div>
          <div class="seat seat--8" data-index="8">
            <div class="ring"></div>
            <img class="avatar placeholder" src="/seat_empty.png" alt="Empty seat">
            <img class="avatar player" src="/avatar_1.png" alt="Player" />
            <div class="nick">—</div>
            <div class="stack">—</div>
          </div>

          <!-- ===== POT / INFO STRIP ===== -->
          <div class="info">
            <div class="pot">
              <img src="/chip_100.png" alt="" class="chip">
              <span id="pot-amount">0</span>
            </div>
            <div class="turn" id="turn-label">Waiting…</div>
          </div>
        </section>

        <!-- ===== ACTION PANEL (disabled – kasnije) ===== -->
        <section class="panel">
          <div class="bets">
            <button class="btn" disabled>Fold</button>
            <button class="btn" disabled>Check</button>
            <button class="btn" disabled>Call</button>
            <button class="btn" disabled>Raise</button>
            <button class="btn primary" disabled>All-in</button>
          </div>
          <div class="sizing">
            <button class="btn tiny" disabled>2×BB</button>
            <button class="btn tiny" disabled>3×BB</button>
            <button class="btn tiny" disabled>½ pot</button>
            <button class="btn tiny" disabled>pot</button>
            <input class="bet-input" type="number" min="0" step="1" placeholder="Bet…" disabled />
          </div>
        </section>
      </main>
    </section>
  </main>

  <div id="toast"></div>

  <script>
    // ===== Helpers =====
    const $ = s => document.querySelector(s);
    const api = async (path, opts={})=>{
      const res = await fetch(path, { credentials:"include", headers:{ "Content-Type":"application/json", ...(opts.headers||{})}, ...opts });
      let data=null; try{ data=await res.json(); }catch{}
      if(!res.ok) throw new Error((data && data.error) || `HTTP ${res.status}`);
      return data;
    };
    const toast = (t, ok=true)=>{ const el=$("#toast"); el.textContent=t; el.style.borderColor = ok?"#1f4f2a":"#4f1f1f"; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"), 1800); };

    // Local nickname (dok server nema nickname polje)
    const getNick = ()=> localStorage.getItem("nick") || "";
    const setNick  = v => localStorage.setItem("nick", String(v||"").slice(0,24));

    // ===== GLOBAL STATE =====
    let ME = null;      // {id,email,is_admin,gold,silver}
    let WS = null;      // WebSocket
    let CUR_TABLE = null;  // last table row
    let CUR_TABLE_ID = null;

    // ===== UI Switch =====
    function show(page){
      $("#page-auth") .classList.toggle("hidden", page!=="auth");
      $("#page-lobby").classList.toggle("hidden", page!=="lobby");
      $("#page-table").classList.toggle("hidden", page!=="table");
    }
    function updateTopbar(){
      if (ME){
        $("#who").textContent = `${ME.email}`;
        $("#balance").textContent = `${ME.gold}g ${ME.silver}s`;
        $("#btn-logout").classList.remove("hidden");
      }else{
        $("#who").textContent = "Not logged in";
        $("#balance").textContent = "0g 0s";
        $("#btn-logout").classList.add("hidden");
      }
    }

    // ===== AUTH =====
    function wireAuthTabs(){
      const regTab = $("#tab-register");
      const logTab = $("#tab-login");
      const regPane= $("#pane-register");
      const logPane= $("#pane-login");
      const act = (tab)=>{
        regTab.classList.toggle("active", tab==="reg");
        logTab.classList.toggle("active", tab==="log");
        regPane.classList.toggle("hidden", tab!=="reg");
        logPane.classList.toggle("hidden", tab!=="log");
      };
      regTab.onclick = ()=> act("reg");
      logTab.onclick = ()=> act("log");
      act("reg");
    }

    async function tryMe(){
      try{
        const r = await api("/api/me");
        ME = r.user;
      }catch{ ME = null; }
      updateTopbar();
      if (ME){ show("lobby"); loadLobby(); openWS(); }
      else { show("auth"); }
    }

    async function doRegister(){
      $("#msg-register").textContent = "Registering…";
      const email = $("#reg-email").value.trim();
      const pass  = $("#reg-pass").value;
      const nick  = $("#reg-nick").value.trim();
      try{
        await api("/api/register", { method:"POST", body: JSON.stringify({ email, password: pass }) });
        setNick(nick);
        await doLogin(email, pass, true);
        $("#msg-register").textContent = "";
      }catch(e){
        $("#msg-register").textContent = e.message;
      }
    }

    async function doLogin(emailOpt=null, passOpt=null, fromRegister=false){
      $("#msg-login").textContent = fromRegister ? "" : "Logging in…";
      const email = emailOpt || $("#login-email").value.trim();
      const pass  = passOpt  || $("#login-pass").value;
      try{
        const r = await api("/api/login", { method:"POST", body: JSON.stringify({ email, password: pass }) });
        ME = r.user;
        updateTopbar();
        show("lobby");
        loadLobby();
        openWS();
        $("#msg-login").textContent = "";
        toast("Logged in", true);
      }catch(e){
        $("#msg-login").textContent = e.message;
      }
    }

    async function doLogout(){
      try{ await api("/api/logout"); }catch{}
      ME=null; updateTopbar();
      if (WS){ try{ WS.close(); }catch{} WS=null; }
      show("auth");
    }

    // ===== LOBBY =====
    async function loadLobby(){
      const box = $("#lobby-list");
      box.textContent = "Loading…";
      try{
        const r = await api("/api/poker/lobby");
        const rows = r.tables || [];
        if (!rows.length){ box.textContent = "No tables."; return; }
        // Render
        const frag = document.createDocumentFragment();
        rows.forEach(t=>{
          const div = document.createElement("div");
          div.className = "card";
          const players = Number(t.players||0);
          div.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
              <div>
                <div style="font-weight:600">${t.name}</div>
                <div class="muted">${t.seats}-max • ${t.sb_s/100}/${t.bb_s/100} g • timer ${t.turn_timer_s}s</div>
              </div>
              <div class="muted">${players}/${t.seats} players</div>
              <div>
                <button class="btn" data-id="${t.id}">Uđi</button>
              </div>
            </div>`;
          frag.appendChild(div);
        });
        box.innerHTML = "";
        box.appendChild(frag);
        box.querySelectorAll("button.btn").forEach(b=>{
          b.addEventListener("click", ()=> enterTable(parseInt(b.dataset.id,10)));
        });
      }catch(e){
        box.textContent = e.message || "Failed.";
      }
    }

    // ===== TABLE =====
    async function enterTable(id){
      CUR_TABLE_ID = id;
      show("table");
      await refreshTableState();
    }

    async function refreshTableState(){
      if (!CUR_TABLE_ID) return;
      try{
        const r = await api(`/api/poker/table/${CUR_TABLE_ID}/state`);
        CUR_TABLE = r.table;
        renderTableMeta(r.table);
        renderSeats(r.seats||[]);
        renderBoardStr(r.hand?.board || "");
      }catch(e){
        toast(e.message, false);
      }
    }

    function renderTableMeta(t){
      $("#table-status").textContent = `${t.name} • ${t.bb_s/100}g BB • ${t.seats}-max`;
      const el = document.getElementById("table");
      el.setAttribute("data-seats", String(t.seats||9));
    }

    function renderSeats(seats){
      // seats: [{seat_index,user_id,stack_s,state,in_hand,last_action}]
      seats.forEach(s=>{
        const el = document.querySelector(`.seat[data-index="${s.seat_index}"]`);
        if(!el) return;
        const nickEl = el.querySelector(".nick");
        const stackEl= el.querySelector(".stack");
        const ph = el.querySelector(".avatar.placeholder");
        const pl = el.querySelector(".avatar.player");
        // occupied?
        const occ = s.user_id!=null && (s.state==="occupied" || s.state==="sitout");
        el.classList.toggle("occupied", !!occ);
        ph.style.display = occ ? "none" : "block";
        pl.style.display = occ ? "block" : "none";
        // nick
        let label = "—";
        if (occ){
          if (ME && s.user_id===ME.id){
            label = getNick() || ME.email;
          } else {
            label = `Player #${s.user_id}`;
          }
        }
        nickEl.textContent = label;
        // stack (u gold/silver)
        const g = Math.floor((s.stack_s|0)/100), si = (s.stack_s|0)%100;
        stackEl.textContent = occ ? `${g}g ${si}s` : "—";
        // ring (acting)
        el.classList.toggle("acting", !!s.in_hand && s.last_action==="acting");
      });
    }

    function renderBoardStr(boardStr){
      const arr = boardStr ? boardStr.split(",").filter(Boolean) : [];
      const slots = [
        ".flop1",".flop2",".flop3",".turn",".river"
      ];
      for (let i=0;i<slots.length;i++){
        const el = document.querySelector(`.board ${slots[i]} img`);
        if (!el) continue;
        const code = arr[i] || null;
        el.src = code ? `/card_${code}.png` : "/card_front_blank.png";
        el.alt = code || "";
      }
    }

    // Join / Leave
    async function doJoin(){
      if (!CUR_TABLE_ID){ toast("No table.", false); return; }
      // buyin prompt u BB
      const bb = CUR_TABLE?.bb_s || 200;
      let buyinBB = prompt(`Buy-in u BB (min ${CUR_TABLE.min_buyin_bb}, max ${CUR_TABLE.max_buyin_bb})`, String(CUR_TABLE.min_buyin_bb||50));
      if (!buyinBB) return;
      buyinBB = Math.max(CUR_TABLE.min_buyin_bb, Math.min(CUR_TABLE.max_buyin_bb, parseInt(buyinBB,10)||CUR_TABLE.min_buyin_bb));
      try{
        const r = await api(`/api/poker/table/${CUR_TABLE_ID}/join`, { method:"POST", body: JSON.stringify({ buyin_bb: buyinBB }) });
        toast(`Sjeo si na mjesto ${r.seat_index} (+${Math.floor(r.stack_s/100)}g).`, true);
        await tryMe();         // refresh balance
        await refreshTableState();
      }catch(e){ toast(e.message, false); }
    }
    async function doLeave(){
      if (!CUR_TABLE_ID) return;
      try{
        const r = await api(`/api/poker/table/${CUR_TABLE_ID}/leave`, { method:"POST" });
        toast(`Leave: vraćeno ${Math.floor(r.returned_s/100)}g.`, true);
        await tryMe();
        await refreshTableState();
      }catch(e){ toast(e.message, false); }
    }

    // ===== WS =====
    function openWS(){
      try{ if (WS) { WS.close(); WS=null; } }catch{}
      const url = (location.protocol==="https:"?"wss://":"ws://") + location.host + "/";
      WS = new WebSocket(url);
      WS.onopen  = ()=>{/* ping je opcionalan */};
      WS.onclose = ()=>{/* auto-reconnect jednostavno: pri slijedećem actionu */};
      WS.onmessage = (e)=>{
        let m=null; try{ m=JSON.parse(e.data); }catch{ return; }
        const t = m.type;
        if (t==="connection_open"){ /* { env, uid } */ }
        if (t==="lobby_update"){ if ($("#page-lobby") && !$("#page-lobby").classList.contains("hidden")) loadLobby(); }
        if (t==="table_state"){
          if (CUR_TABLE_ID && m.table_id===CUR_TABLE_ID){
            CUR_TABLE = m.table; renderTableMeta(m.table); renderSeats(m.seats||[]);
          }
        }
        if (t==="board_update"){
          if (CUR_TABLE_ID && m.table_id===CUR_TABLE_ID){
            // m.board: ["AS","KD","QH",...]
            const joined = (m.board||[]).join(",");
            renderBoardStr(joined);
          }
        }
        if (t==="action_required"){
          if (CUR_TABLE_ID && m.table_id===CUR_TABLE_ID){
            const all = document.querySelectorAll(".seat"); all.forEach(s=>s.classList.remove("acting"));
            const el = document.querySelector(`.seat[data-index="${m.seat_index}"]`);
            if (el) el.classList.add("acting");
            const sec = Math.max(0, Math.floor((m.ms_left||0)/1000));
            $("#turn-label").textContent = `Na potezu: seat ${m.seat_index} • ${sec}s`;
          }
        }
        if (t==="player_action"){
          // za sad samo osvježi state
          if (CUR_TABLE_ID && m.table_id===CUR_TABLE_ID){ refreshTableState(); }
        }
        if (t==="showdown"){
          if (CUR_TABLE_ID && m.table_id===CUR_TABLE_ID){
            // prikaz potova i isplata u labeli
            const total = (m.results||[]).reduce((a,b)=>a+(b.amount_s||0),0);
            $("#turn-label").textContent = `Showdown • total ${Math.floor(total/100)}g`;
          }
        }
        if (t==="payouts"){
          if (CUR_TABLE_ID && m.table_id===CUR_TABLE_ID){
            const total = (m.payouts||[]).reduce((a,b)=>a+(b.amount_s||0),0);
            $("#turn-label").textContent = `Payouts • ${Math.floor(total/100)}g`;
            tryMe(); // refresh balance
          }
        }
        if (t==="error"){
          toast(`${m.code}${m.message?": "+m.message:""}`, false);
        }
      };
    }

    // ===== Wire buttons =====
    wireAuthTabs();
    $("#btn-register").addEventListener("click", doRegister);
    $("#btn-login").addEventListener("click", ()=> doLogin());
    $("#btn-logout").addEventListener("click", doLogout);
    $("#btn-refresh-lobby").addEventListener("click", loadLobby);
    $("#btn-back-lobby").addEventListener("click", ()=>{ show("lobby"); loadLobby(); });
    $("#btn-join").addEventListener("click", doJoin);
    $("#btn-leave").addEventListener("click", doLeave);

    // Go
    tryMe();
  </script>
</body>
</html>
