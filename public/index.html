<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>POKER</title>
  <style>
    :root{ --bg:#0b1220; --card:#121a2b; --line:#233047; --text:#e5e7eb; --muted:#9aa4b2; --ok:#10b981; --bad:#ef4444; --btn:#2563eb; }
    *{ box-sizing:border-box } body{ margin:0; background:var(--bg); color:var(--text); font:14px/1.4 system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial }
    .wrap{ max-width:980px; margin:0 auto; padding:16px }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:16px; margin:12px 0 }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .col{ display:flex; flex-direction:column; gap:8px }
    input,select{ background:#0f172a; border:1px solid var(--line); color:var(--text); padding:10px 12px; border-radius:10px; width:100% }
    button{ background:var(--btn); color:#fff; border:0; padding:10px 14px; border-radius:10px; cursor:pointer }
    button.ghost{ background:transparent; border:1px solid var(--line) }
    .muted{ color:var(--muted) } .right{ margin-left:auto } .hidden{ display:none }
    table{ width:100%; border-collapse:collapse } th,td{ padding:8px 10px; border-bottom:1px solid var(--line); text-align:left }
    .pill{ padding:3px 8px; border-radius:999px; background:#0f1b34; border:1px solid var(--line); font-weight:600 }
    .ok{ color:var(--ok) } .bad{ color:var(--bad) }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px } @media(max-width:900px){ .grid2{ grid-template-columns:1fr } }
    #toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px; border:1px solid var(--line) }
    #board{ display:flex; gap:8px } .cardimg{ width:56px; height:76px; background:#0f172a; border:1px solid var(--line); border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:700 }
    .seat{ padding:10px; border:1px solid var(--line); border-radius:10px; background:#0f172a }
    .seat.me{ outline:2px solid var(--ok) }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>POKER</h1>

    <!-- AUTH -->
    <div id="auth" class="card">
      <div class="grid2">
        <div>
          <h3>Prijava</h3>
          <div class="col">
            <input id="login-email" type="email" placeholder="Email" />
            <input id="login-pass" type="password" placeholder="Lozinka" />
            <div class="row">
              <button id="btn-login">Login</button>
              <span id="login-msg" class="muted"></span>
            </div>
          </div>
        </div>
        <div>
          <h3>Registracija</h3>
          <div class="col">
            <input id="reg-email" type="email" placeholder="Email" />
            <input id="reg-pass" type="password" placeholder="Lozinka (min 6)" />
            <input id="reg-nick" type="text" placeholder="Nickname (3–16, A-Z 0-9 _ . -)" />
            <div class="row">
              <button id="btn-register">Kreiraj račun</button>
              <span id="reg-msg" class="muted"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- DASH -->
    <div id="dash" class="card hidden">
      <div class="row">
        <div><b id="user-email"></b> <span class="muted">(<span id="user-nick"></span>)</span></div>
        <div class="pill">Chips: <span id="user-gold">0</span>g <span id="user-silver">0</span>s</div>
        <button id="btn-logout" class="right ghost">Logout</button>
      </div>
    </div>

    <!-- LOBBY -->
    <div id="lobby" class="card hidden">
      <div class="row">
        <h3 style="margin:0">Lobby</h3>
        <button id="btn-refresh" class="right ghost">Osvježi</button>
      </div>
      <table id="tbl-lobby">
        <thead><tr><th>Stol</th><th>Seats</th><th>Blinds</th><th>Buy-in (BB)</th><th>Igrača</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- TABLE -->
    <div id="table" class="card hidden">
      <div class="row">
        <h3 id="t-name" style="margin:0">Stol</h3>
        <span class="muted" id="t-blinds"></span>
        <span class="pill" id="t-state"></span>
        <button id="btn-back" class="right ghost">← Lobby</button>
      </div>

      <div class="grid2">
        <div class="col">
          <div id="board" class="row"></div>
          <div id="seats" class="col"></div>
        </div>
        <div class="col">
          <div class="card">
            <div class="row">
              <input id="inp-buyin" type="number" placeholder="Buy-in u BB (npr. 50)" />
              <input id="inp-seat" type="number" placeholder="Seat index (0-8)" />
              <button id="btn-join">Join</button>
              <button id="btn-rebuy" class="ghost">Rebuy</button>
              <button id="btn-leave" class="ghost">Leave</button>
            </div>
          </div>
          <div class="card">
            <div class="row">
              <button data-act="check" class="ghost">Check</button>
              <button data-act="call"  class="ghost">Call</button>
              <input id="inp-bet" type="number" placeholder="Iznos (s)" />
              <button data-act="bet">Bet</button>
              <button data-act="raise">Raise</button>
              <button data-act="fold" class="ghost">Fold</button>
              <button data-act="allin" class="bad">All-in</button>
            </div>
            <div class="muted" id="act-hint"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="toast" class="hidden"></div>
  </div>

<script>
(function(){
  // Helpers
  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const toast = (t)=>{ const b=$("#toast"); b.textContent=t; b.classList.remove("hidden"); setTimeout(()=>b.classList.add("hidden"), 2200); };
  const api = async (url, opt={})=>{
    const r = await fetch(url, { headers:{ "Content-Type":"application/json", ...(opt.headers||{}) }, credentials:"include", ...opt });
    const j = await r.json().catch(()=>({ok:false,error:"Bad JSON"}));
    if (!r.ok || !j.ok) throw new Error(j.error||("HTTP "+r.status));
    return j;
  };

  // State
  let me=null, ws=null, curTable=null;

  // UI refs
  const auth  = $("#auth");
  const dash  = $("#dash");
  const lobby = $("#lobby");
  const table = $("#table");

  function showAuth(){ auth.classList.remove("hidden"); dash.classList.add("hidden"); lobby.classList.add("hidden"); table.classList.add("hidden"); }
  function showLobby(){ auth.classList.add("hidden"); dash.classList.remove("hidden"); lobby.classList.remove("hidden"); table.classList.add("hidden"); }
  function showTable(){ auth.classList.add("hidden"); dash.classList.remove("hidden"); lobby.classList.add("hidden"); table.classList.remove("hidden"); }

  async function refreshMe(){
    try{
      const j = await api("/api/me");
      me = j.user;
      $("#user-email").textContent = me.email;
      $("#user-nick").textContent  = me.nickname || "—";
      $("#user-gold").textContent  = me.gold|0;
      $("#user-silver").textContent= me.silver|0;
      return true;
    }catch{ me=null; return false; }
  }

  async function loadLobby(){
    const j = await api("/api/poker/lobby");
    const tb = $("#tbl-lobby tbody"); tb.innerHTML="";
    for (const t of j.tables){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${t.name}</td>
        <td>${t.seats}</td>
        <td>${(t.sb_s/100)|0}g/${(t.bb_s/100)|0}g</td>
        <td>${t.min_buyin_bb}–${t.max_buyin_bb}</td>
        <td>${t.players||0}</td>
        <td><button data-id="${t.id}" class="btn-open">Otvori</button></td>`;
      tb.appendChild(tr);
    }
    $$(".btn-open").forEach(b=> b.onclick = ()=> openTable(parseInt(b.getAttribute("data-id"),10)));
  }

  async function openTable(id){
    const j = await api(`/api/poker/table/${id}/state`);
    curTable = j.table;
    $("#t-name").textContent = curTable.name;
    $("#t-blinds").textContent = `Blinds: ${curTable.sb_s/100}g / ${curTable.bb_s/100}g`;
    $("#t-state").textContent = j.hand ? j.hand.state : "waiting";
    renderBoard(j.hand?.board||"");
    renderSeats(j.seats);
    showTable();
    ensureWS();
  }

  function renderBoard(boardStr){
    const b = $("#board"); b.innerHTML="";
    const cards = (boardStr||"").split(",").filter(Boolean);
    for (let c of cards){
      const div = document.createElement("div"); div.className="cardimg"; div.textContent=c; b.appendChild(div);
    }
  }
  function renderSeats(seats){
    const box = $("#seats"); box.innerHTML="";
    seats.forEach(s=>{
      const div = document.createElement("div");
      div.className = "seat" + (s.user_id===me?.id ? " me" : "");
      div.innerHTML = `
        <div><b>Seat ${s.seat_index}</b></div>
        <div>Stack: ${(s.stack_s/100)|0}g ${(s.stack_s%100)|0}s</div>
        <div>State: ${s.state}${s.in_hand? " (in hand)":""}</div>
        <div class="muted">${s.last_action || ""}</div>
      `;
      box.appendChild(div);
    });
  }

  function ensureWS(){
    if (ws && ws.readyState===1) return;
    ws = new WebSocket((location.protocol==="https:"?"wss://":"ws://")+location.host);
    ws.onopen = ()=> console.log("WS open");
    ws.onmessage = (ev)=>{
      let m; try{ m=JSON.parse(ev.data); }catch{ return; }
      if (m.type==="table_state" && m.table_id===curTable?.id){
        $("#t-state").textContent = m.table?.status || m.table?.state || "live";
        renderSeats(m.seats||[]);
      }
      if (m.type==="board_update" && curTable && m.table_id===curTable.id){
        renderBoard((m.board||[]).join(","));
      }
      if (m.type==="action_required" && curTable){
        $("#act-hint").textContent = `Na potezu: seat ${m.seat_index} — ${Math.floor((m.ms_left||0)/1000)}s`;
      }
      if (m.type==="error"){ toast("Greška: "+(m.message||m.code)); }
    };
  }

  // Buttons
  $("#btn-login").onclick = async ()=>{
    try{
      const email = $("#login-email").value.trim();
      const pass  = $("#login-pass").value;
      await api("/api/login",{ method:"POST", body:JSON.stringify({ email, password:pass }) });
      await refreshMe(); await loadLobby(); showLobby(); toast("Ulogovan");
    }catch(e){ $("#login-msg").textContent = e.message; }
  };
  $("#btn-register").onclick = async ()=>{
    try{
      const email = $("#reg-email").value.trim();
      const pass  = $("#reg-pass").value;
      const nick  = $("#reg-nick").value.trim();
      await api("/api/register",{ method:"POST", body:JSON.stringify({ email, password:pass, nickname:nick }) });
      toast("Račun kreiran — sada se uloguj"); $("#reg-msg").textContent="";
    }catch(e){ $("#reg-msg").textContent = e.message; }
  };
  $("#btn-logout").onclick = async ()=>{ try{ await api("/api/logout"); me=null; showAuth(); toast("Odjavljeno"); }catch{} };
  $("#btn-refresh").onclick = ()=> loadLobby();
  $("#btn-back").onclick    = ()=> showLobby();

  $("#btn-join").onclick = async ()=>{
    if (!curTable) return;
    try{
      const buyin = parseInt($("#inp-buyin").value,10)||0;
      const seat  = parseInt($("#inp-seat").value,10); // -1 za auto
      const j = await api(`/api/poker/table/${curTable.id}/join`, { method:"POST", body:JSON.stringify({ buyin_bb:buyin, seat_index:isFinite(seat)?seat:-1 }) });
      toast(`Sjeo si na seat ${j.seat_index} (stack ${(j.stack_s/100)|0}g)`);
      await openTable(curTable.id);
    }catch(e){ toast("Join: "+e.message); }
  };
  $("#btn-rebuy").onclick = async ()=>{
    if (!curTable) return;
    try{
      const buyin = parseInt($("#inp-buyin").value,10)||0;
      const j = await api(`/api/poker/table/${curTable.id}/rebuy`, { method:"POST", body:JSON.stringify({ buyin_bb:buyin }) });
      toast(`Rebuy OK (seat ${j.seat_index}, stack ${(j.stack_s/100)|0}g)`);
      await openTable(curTable.id);
    }catch(e){ toast("Rebuy: "+e.message); }
  };
  $("#btn-leave").onclick = async ()=>{
    if (!curTable) return;
    try{
      const j = await api(`/api/poker/table/${curTable.id}/leave`, { method:"POST" });
      toast(`Leave OK (vraceno ${(j.returned_s/100)|0}g ${(j.returned_s%100)|0}s)`);
      await openTable(curTable.id);
    }catch(e){ toast("Leave: "+e.message); }
  };

  // Actions
  $$("#table [data-act]").forEach(b=>{
    b.onclick = ()=>{
      if (!curTable || !ws || ws.readyState!==1) return toast("WS nije spreman");
      const act = b.getAttribute("data-act");
      const amt = parseInt($("#inp-bet").value,10)|0;
      ws.send(JSON.stringify({ type:"player_action", payload:{ table_id:curTable.id, seat_index:0, action:act, amount_s:amt } }));
      // seat_index:0 je placeholder — klijent obično zna svoj seat; u produkciji dohvati ga iz seats[] gdje user_id===me.id
    };
  });

  // Boot
  (async ()=>{
    if (await refreshMe()){ await loadLobby(); showLobby(); } else { showAuth(); }
  })();

})();
</script>
</body>
</html>
