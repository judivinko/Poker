<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Poker Lobby</title>
<link rel="stylesheet" href="/app.css">
<style>
:root{ --bg:#0b0d13; --panel:#111722; --muted:#94a3b8; --br:#243041; --btn:#22d3ee; }
body{ margin:0; background:var(--bg); color:#e5e7eb; font:14px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif; }
.wrap{ max-width:820px; margin:0 auto; padding:20px; display:flex; flex-direction:column; gap:16px; }
.card{ background:var(--panel); border:1px solid var(--br); border-radius:12px; padding:14px; }
.row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.col{ display:flex; flex-direction:column; gap:8px; }
button{ background:var(--btn); color:#000; border:none; border-radius:8px; padding:10px 14px; font-weight:700; cursor:pointer; }
button.secondary{ background:#2b3445; color:#e5e7eb; }
input,select{ background:#0b1220; border:1px solid var(--br); border-radius:8px; padding:10px; color:#e5e7eb; }
.muted{ color:var(--muted); }
.hidden{ display:none !important; }
.item{ display:flex; justify-content:space-between; align-items:center; background:#0f1624; border:1px solid var(--br); border-radius:10px; padding:10px;}
.avatar{ width:42px; height:42px; border-radius:50%; object-fit:cover; }
#profile-box,#make-box,#join-box{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55); }
.modal{ width:min(92vw,360px); background:#0f1624; border:1px solid var(--br); border-radius:12px; padding:16px; display:flex; flex-direction:column; gap:10px; }
.grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
</style>
</head>
<body>

<div class="wrap">

  <h1 style="text-align:center;">POKER LOBBY</h1>

  <!-- AUTH -->
  <section class="card" id="auth">
    <div class="row" style="justify-content:space-between;">
      <div class="col">
        <div class="muted" style="font-weight:700;">Login</div>
        <input id="login-email" type="email" placeholder="email">
        <input id="login-pass" type="password" placeholder="password">
        <button id="btn-login">Login</button>
      </div>
      <div class="col">
        <div class="muted" style="font-weight:700;">Registracija</div>
        <input id="reg-email" type="email" placeholder="email">
        <input id="reg-pass" type="password" placeholder="password (min 6)">
        <button id="btn-register">Kreiraj</button>
      </div>
    </div>
    <div id="auth-msg" class="muted" style="margin-top:6px;"></div>
  </section>

  <!-- WHO -->
  <section class="card hidden" id="who">
    <div class="row" style="justify-content:space-between;">
      <div class="row" style="gap:10px;">
        <img id="who-avatar" class="avatar" src="/avatar_1.png">
        <div>
          <div id="who-email" style="font-weight:700;">—</div>
          <div id="who-balance" class="muted">—</div>
        </div>
      </div>
      <div class="row">
        <button class="secondary" id="btn-open-profile">Profil</button>
        <button id="btn-open-make">+ Sto</button>
        <button class="secondary" id="btn-logout">Logout</button>
      </div>
    </div>
  </section>

  <!-- LOBBY -->
  <section class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="muted">Stolovi</div>
      <button class="secondary" id="btn-refresh">Osvježi</button>
    </div>
    <div id="list" style="margin-top:10px;">Loading…</div>
  </section>

</div>

<!-- CREATE TABLE MODAL -->
<div id="make-box">
  <div class="modal">
    <div class="muted" style="font-weight:700;">Kreiraj sto</div>
    <label>Broj mjesta</label>
    <select id="make-seats"><option>2</option><option>6</option><option selected>9</option></select>
    <label>Small Blind</label>
    <input id="make-sb" type="number" value="1">
    <label>Big Blind</label>
    <input id="make-bb" type="number" value="2">
    <button id="btn-create">Kreiraj</button>
    <button class="secondary" id="btn-close-make">Zatvori</button>
    <div id="make-msg" class="muted"></div>
  </div>
</div>

<!-- JOIN TABLE MODAL -->
<div id="join-box">
  <div class="modal">
    <div class="muted" style="font-weight:700;">Join Sto #<span id="join-id"></span></div>
    <label>Sjedalo</label>
    <select id="join-seat"></select>
    <label>Buy-in (min-max automatski)</label>
    <input id="join-buy" type="number" value="0">
    <div id="join-range" class="muted"></div>
    <button id="btn-join-confirm">Join</button>
    <button class="secondary" id="btn-close-join">Zatvori</button>
    <div id="join-msg" class="muted"></div>
  </div>
</div>

<!-- PROFILE MODAL -->
<div id="profile-box">
  <div class="modal">
    <div class="muted" style="font-weight:700;">Tvoj profil</div>
    <div class="row">
      <img id="profile-avatar-preview" class="avatar" src="/avatar_1.png">
      <div>
        <div id="profile-email">—</div>
        <div id="profile-balance" class="muted">—</div>
      </div>
    </div>
    <div class="muted">Odaberi avatar</div>
    <div id="avatar-grid" class="grid"></div>
    <button class="secondary" id="btn-close-profile">Zatvori</button>
    <div id="profile-msg" class="muted"></div>
  </div>
</div>

<script>
const $=s=>document.querySelector(s);

let ME=null;

// ---------- AUTH ----------
async function me(){
  const r = await fetch("/api/me").then(r=>r.json()).catch(()=>null);
  if(r?.ok){
    ME=r.user;
    $("#auth").classList.add("hidden");
    $("#who").classList.remove("hidden");
    $("#who-email").textContent=ME.email;
    $("#who-balance").textContent=ME.balance+" čipova";
    $("#who-avatar").src=ME.avatar;
  }else{
    ME=null;
    $("#auth").classList.remove("hidden");
    $("#who").classList.add("hidden");
  }
}
$("#btn-login").onclick=async()=>{
  const email=$("#login-email").value.trim();
  const pass=$("#login-pass").value;
  const r=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email,password:pass})}).then(r=>r.json());
  $("#auth-msg").textContent=r.ok?"Ulogiran":(r.error||"greška");
  await me(); await loadTables();
}
$("#btn-register").onclick=async()=>{
  const email=$("#reg-email").value.trim();
  const pass=$("#reg-pass").value;
  const r=await fetch("/api/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email,password:pass})}).then(r=>r.json());
  $("#auth-msg").textContent=r.ok?"Račun kreiran, login.":(r.error||"greška");
}
$("#btn-logout").onclick=async()=>{await fetch("/api/logout"); await me(); await loadTables();};

// ---------- TABLE LIST ----------
async function loadTables(){
  const r=await fetch("/api/tables").then(r=>r.json()).catch(()=>null);
  const box=$("#list");
  if(!r?.ok) return box.textContent="Greška.";
  box.innerHTML="";
  if(!r.tables.length) return box.textContent="Nema stolova.";
  for(const t of r.tables){
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`<div>#${t.id} • ${t.players}/${t.seats} igrača • SB:${t.sb} BB:${t.bb}</div>
    <button>Join</button>`;
    div.querySelector("button").onclick=()=>openJoin(t);
    box.appendChild(div);
  }
}
$("#btn-refresh").onclick=loadTables;

// ---------- CREATE TABLE ----------
$("#btn-open-make").onclick=()=>{$("#make-box").style.display="flex";}
$("#btn-close-make").onclick=()=>{$("#make-box").style.display="none";}
$("#btn-create").onclick=async()=>{
  const seats=$("#make-seats").value|0;
  const sb=$("#make-sb").value|0;
  const bb=$("#make-bb").value|0;
  const r=await fetch("/api/table/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({seats,sb,bb}),credentials:"include"}).then(r=>r.json());
  if(r.ok) location.href="/table?id="+r.table_id;
  else $("#make-msg").textContent=r.error||"greška";
};

// ---------- JOIN ----------
let JOIN_TABLE=null;
function openJoin(t){
  JOIN_TABLE=t;
  $("#join-id").textContent=t.id;
  $("#join-box").style.display="flex";

  // slobodna sjedala
  const sel=$("#join-seat");
  sel.innerHTML="";
  for(let i=0;i<t.seats;i++){
    sel.innerHTML+=`<option value="${i}">Seat ${i+1}</option>`;
  }

  const min = t.bb*50;
  const max = t.bb*200;
  $("#join-range").textContent=`Buy-in: ${min} - ${max}`;
  $("#join-buy").value=min;
}
$("#btn-close-join").onclick=()=>$("#join-box").style.display="none";

$("#btn-join-confirm").onclick=async()=>{
  const seat_index=$("#join-seat").value|0;
  const buyin=$("#join-buy").value|0;
  const r=await fetch("/api/table/join",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({table_id:JOIN_TABLE.id,seat_index,buyin}),credentials:"include"}).then(r=>r.json());
  if(r.ok) location.href="/table?id="+JOIN_TABLE.id;
  else $("#join-msg").textContent=r.error||"Greška";
};

// ---------- PROFILE ----------
$("#btn-open-profile").onclick=async()=>{
  if(!ME) await me();
  $("#profile-email").textContent=ME.email;
  $("#profile-balance").textContent=ME.balance+" čipova";
  $("#profile-avatar-preview").src=ME.avatar;
  const r=await fetch("/api/avatars").then(r=>r.json());
  const grid=$("#avatar-grid"); grid.innerHTML="";
  (r.avatars||[]).forEach(src=>{
    const img=document.createElement("img");
    img.className="avatar";
    img.src=src;
    img.onclick=async()=>{
      const rr=await fetch("/api/me/avatar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({avatar:src}),credentials:"include"}).then(r=>r.json());
      if(rr.ok){ $("#profile-avatar-preview").src=src; await me(); $("#profile-msg").textContent="Promijenjeno."; }
    };
    grid.appendChild(img);
  });
  $("#profile-box").style.display="flex";
};
$("#btn-close-profile").onclick=()=>$("#profile-box").style.display="none";

// ---------- WS AUTO REFRESH LOBBY ----------
function connectWS(){
  const ws=new WebSocket((location.protocol==="https:"?"wss":"ws")+"://"+location.host);
  ws.onmessage=ev=>{
    try{const msg=JSON.parse(ev.data); if(msg.type==="lobby") loadTables();}catch{}
  };
  ws.onclose=()=>setTimeout(connectWS,1500);
}
connectWS();

// ---------- INIT ----------
(async()=>{await me(); await loadTables();})();
</script>

</body>
</html>
