<!-- ===== DIO 1/2 (HTML + CSS + BODY) ===== -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Poker Lobby</title>
<link rel="stylesheet" href="/app.css">
<style>
:root{ --bg:#0b0d13; --panel:#111722; --muted:#94a3b8; --br:#243041; --btn:#22d3ee; }
body{ margin:0; background:var(--bg); color:#e5e7eb; font:14px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif; }
.wrap{ max-width:920px; margin:0 auto; padding:24px; display:flex; flex-direction:column; gap:16px; }
.card{ background:var(--panel); border:1px solid var(--br); border-radius:14px; padding:16px; }
.row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
.col{ display:flex; flex-direction:column; gap:8px; }
button{ background:var(--btn); color:#000; border:none; border-radius:10px; padding:10px 16px; font-weight:800; cursor:pointer; }
button.secondary{ background:#2b3445; color:#e5e7eb; }
input,select{ background:#0b1220; border:1px solid var(--br); border-radius:10px; padding:10px; color:#e5e7eb; }
.muted{ color:var(--muted); }
.hidden{ display:none !important; }
.item{ display:flex; justify-content:space-between; align-items:center; background:#0f1624; border:1px solid var(--br); border-radius:12px; padding:12px;}
.avatar{ width:44px; height:44px; border-radius:50%; object-fit:cover; border:1px solid #233047; background:#0b1220; }
#profile-box,#make-box,#join-box{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55); }
.modal{ width:min(92vw,380px); background:#0f1624; border:1px solid var(--br); border-radius:14px; padding:16px; display:flex; flex-direction:column; gap:10px; }
.grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
h1{ text-align:center; margin:6px 0 10px; }
</style>
</head>
<body>

<div class="wrap">

  <h1>POKER LOBBY</h1>

  <section class="card" id="auth">
    <div class="row" style="justify-content:space-between;">
      <div class="col" style="min-width:280px;flex:1">
        <div class="muted" style="font-weight:800;">Login</div>
        <input id="login-email" type="email" placeholder="email">
        <input id="login-pass" type="password" placeholder="password (min 6)">
        <button id="btn-login">Login</button>
      </div>
      <div class="col" style="min-width:280px;flex:1">
        <div class="muted" style="font-weight:800;">Registracija</div>
        <input id="reg-email" type="email" placeholder="email">
        <input id="reg-pass" type="password" placeholder="password (min 6)">
        <button id="btn-register">Kreiraj</button>
      </div>
    </div>
    <div id="auth-msg" class="muted" style="margin-top:6px;"></div>
  </section>

  <section class="card hidden" id="who">
    <div class="row" style="justify-content:space-between;">
      <div class="row" style="gap:12px;">
        <img id="who-avatar" class="avatar" src="/avatar_1.png">
        <div>
          <div id="who-email" style="font-weight:800;">—</div>
          <div id="who-balance" class="muted">—</div>
        </div>
      </div>
      <div class="row">
        <button class="secondary" id="btn-open-profile">Profil</button>
        <button id="btn-open-make">+ Sto</button>
        <button class="secondary" id="btn-logout">Logout</button>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="muted">Stolovi</div>
      <button class="secondary" id="btn-refresh">Osvježi</button>
    </div>
    <div id="list" style="margin-top:10px;">Nema stolova.</div>
  </section>

</div>

<div id="make-box">
  <div class="modal">
    <div class="muted" style="font-weight:800;">Kreiraj sto</div>
    <label>Broj mjesta</label>
    <select id="make-seats"><option>2</option><option>6</option><option selected>9</option></select>
    <label>Small Blind</label>
    <input id="make-sb" type="number" value="1">
    <label>Big Blind</label>
    <input id="make-bb" type="number" value="2">
    <div class="row">
      <button id="btn-create">Kreiraj</button>
      <button class="secondary" id="btn-close-make">Zatvori</button>
    </div>
    <div id="make-msg" class="muted"></div>
  </div>
</div>

<div id="join-box">
  <div class="modal">
    <div class="muted" style="font-weight:800;">Join Sto #<span id="join-id"></span></div>
    <label>Sjedalo</label>
    <select id="join-seat"></select>
    <label>Buy-in (min-max)</label>
    <input id="join-buy" type="number" value="0">
    <div id="join-range" class="muted"></div>
    <div class="row">
      <button id="btn-join-confirm">Join</button>
      <button class="secondary" id="btn-close-join">Zatvori</button>
    </div>
    <div id="join-msg" class="muted"></div>
  </div>
</div>

<div id="profile-box">
  <div class="modal">
    <div class="muted" style="font-weight:800;">Tvoj profil</div>
    <div class="row">
      <img id="profile-avatar-preview" class="avatar" src="/avatar_1.png">
      <div>
        <div id="profile-email">—</div>
        <div id="profile-balance" class="muted">—</div>
      </div>
    </div>
    <div class="muted">Odaberi avatar</div>
    <div id="avatar-grid" class="grid"></div>
    <button class="secondary" id="btn-close-profile">Zatvori</button>
    <div id="profile-msg" class="muted"></div>
  </div>
</div>

  
  
<!-- ===== DIO 2/2 (SCRIPT — ES5 SAFE + DIJAGNOSTIKA) ===== -->
<script>
/* ---------- Dijagnostički HUD (vidiš greške na ekranu) ---------- */
(function(){
  var box = document.createElement("div");
  box.id = "diag";
  box.style.cssText = "position:fixed;left:8px;bottom:8px;max-width:90vw;background:#0b1220;border:1px solid #243041;color:#e5e7eb;border-radius:10px;padding:8px 10px;font:12px/1.3 system-ui;z-index:99999;opacity:.92;display:none;white-space:pre-wrap;";
  document.addEventListener("keydown", function(e){
    // Toggle HUD (Ctrl+D)
    if((e.ctrlKey||e.metaKey) && (e.key==="d"||e.key==="D")){
      box.style.display = (box.style.display==="none"?"block":"none");
    }
  });
  function push(msg){
    box.style.display = "block";
    var p = document.createElement("div");
    p.textContent = msg;
    box.appendChild(p);
  }
  window.__diag = {push: push};
  document.body ? document.body.appendChild(box) : window.addEventListener("DOMContentLoaded", function(){ document.body.appendChild(box); });

  window.addEventListener("error", function(e){ push("JS Error: " + (e.message||"") + " @ " + (e.filename||"") + ":" + (e.lineno||"")); });
  window.addEventListener("unhandledrejection", function(e){ push("Promise Rejection: " + (e.reason && (e.reason.message||e.reason)) ); });
})();

/* ---------- Helperi ---------- */
function $(s){ return document.querySelector(s); }
var ME = null;
var VERSION_BUST = "v3"; // promijeni npr. u v4 kad želiš hard refresh

// fetch s timeoutom + include credentials by default
function safeFetch(url, opts){
  opts = opts || {};
  if (!opts.headers) opts.headers = {};
  if (typeof opts.credentials === "undefined") opts.credentials = "include";

  // cache-bust za GET upite
  if (!opts.method || opts.method.toUpperCase() === "GET") {
    var sep = url.indexOf("?")>=0 ? "&" : "?";
    url = url + sep + "_v=" + VERSION_BUST;
  }

  var timeout = opts.timeout || 12000;
  var ctrl = (window.AbortController ? new AbortController() : null);
  if (ctrl) { opts.signal = ctrl.signal; }
  var to = setTimeout(function(){ if (ctrl) ctrl.abort(); }, timeout);

  return fetch(url, opts).then(function(r){ clearTimeout(to); return r; }).catch(function(err){
    if (window.__diag) __diag.push("Network error ("+url+"): " + (err && err.message ? err.message : err));
    throw err;
  });
}

/* ---------- App logika (ES5 kompatibilno) ---------- */
function me(){
  return safeFetch("/api/me")
    .then(function(r){ return r.json(); })
    .catch(function(){ return null; })
    .then(function(r){
      if (r && r.ok) {
        ME = r.user;
        $("#auth").classList.add("hidden");
        $("#who").classList.remove("hidden");
        $("#who-email").textContent = ME.email;
        $("#who-balance").textContent = ME.balance + " čipova";
        $("#who-avatar").src = ME.avatar || "/avatar_1.png";
      } else {
        ME = null;
        $("#auth").classList.remove("hidden");
        $("#who").classList.add("hidden");
      }
    });
}

$("#btn-login").onclick = function(){
  var email = $("#login-email").value.trim();
  var pass  = $("#login-pass").value;
  return safeFetch("/api/login",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({email:email, password:pass})
  })
  .then(function(r){ return r.json(); })
  .then(function(r){
    $("#auth-msg").textContent = r.ok ? "Ulogiran." : (r.error || "Greška");
    if (!r.ok && window.__diag) __diag.push("Login fail: " + (r.error||"unknown"));
    return me().then(loadTables);
  })
  .catch(function(e){
    $("#auth-msg").textContent = "Mrežna greška";
  });
};

$("#btn-register").onclick = function(){
  var email = $("#reg-email").value.trim();
  var pass  = $("#reg-pass").value;
  return safeFetch("/api/register",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({email:email, password:pass})
  })
  .then(function(r){ return r.json(); })
  .then(function(r){
    $("#auth-msg").textContent = r.ok ? "Račun kreiran. Logiraj se." : (r.error || "Greška");
    if (!r.ok && window.__diag) __diag.push("Register fail: " + (r.error||"unknown"));
  })
  .catch(function(){ $("#auth-msg").textContent = "Mrežna greška"; });
};

$("#btn-logout").onclick = function(){
  return safeFetch("/api/logout").then(function(){
    return me().then(loadTables);
  }).catch(function(){ /* ignoriši */ });
};

function loadTables(){
  return safeFetch("/api/tables")
    .then(function(r){ return r.json(); })
    .catch(function(){ return null; })
    .then(function(r){
      var box = $("#list");
      box.innerHTML = "";
      if (!r || !r.ok || !r.tables || !r.tables.length) {
        box.textContent = "Nema stolova.";
        if (window.__diag && (!r || !r.ok)) __diag.push("Tables fail: " + (r && r.error ? r.error : "no data"));
        return;
      }
      for (var i=0;i<r.tables.length;i++){
        var t = r.tables[i];
        var div = document.createElement("div");
        div.className = "item";
        div.innerHTML = '<div>#'+t.id+' • '+t.players+'/'+t.seats+' • SB:'+t.sb+' BB:'+t.bb+'</div><button>Join</button>';
        div.querySelector("button").onclick = (function(tt){
          return function(){ openJoin(tt); };
        })(t);
        box.appendChild(div);
      }
    });
}
$("#btn-refresh").onclick = loadTables;

$("#btn-open-make").onclick  = function(){ $("#make-box").style.display = "flex"; };
$("#btn-close-make").onclick = function(){ $("#make-box").style.display = "none"; };
$("#btn-create").onclick     = function(){
  var seats = parseInt($("#make-seats").value,10) || 0;
  var sb    = parseInt($("#make-sb").value,10)    || 0;
  var bb    = parseInt($("#make-bb").value,10)    || 0;
  return safeFetch("/api/table/create",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({seats:seats,sb:sb,bb:bb})
  })
  .then(function(r){ return r.json(); })
  .then(function(r){
    if (r && r.ok) {
      $("#make-box").style.display = "none";
      location.href = "/table?id=" + r.table_id;
    } else {
      $("#make-msg").textContent = (r && r.error) ? r.error : "Greška";
      if (window.__diag) __diag.push("Create table fail: " + (r && r.error ? r.error : "unknown"));
    }
  })
  .catch(function(e){ $("#make-msg").textContent = "Mrežna greška"; });
};

var JOIN_TABLE = null;
function openJoin(t){
  JOIN_TABLE = t;
  $("#join-id").textContent = t.id;
  $("#join-box").style.display = "flex";
  var sel = $("#join-seat");
  sel.innerHTML = "";
  for (var i=0;i<t.seats;i++){
    sel.innerHTML += '<option value="'+i+'">Seat '+(i+1)+'</option>';
  }
  var min = t.bb*50, max = t.bb*200;
  $("#join-range").textContent = "Buy-in: " + min + " – " + max;
  $("#join-buy").value = min;
}
$("#btn-close-join").onclick = function(){ $("#join-box").style.display = "none"; };
$("#btn-join-confirm").onclick = function(){
  if (!JOIN_TABLE) return;
  var seat_index = parseInt($("#join-seat").value,10) || 0;
  var buyin      = parseInt($("#join-buy").value,10) || 0;
  return safeFetch("/api/table/join",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({table_id:JOIN_TABLE.id, seat_index:seat_index, buyin:buyin})
  })
  .then(function(r){ return r.json(); })
  .then(function(r){
    if (r && r.ok) {
      $("#join-box").style.display = "none";
      location.href = "/table?id=" + JOIN_TABLE.id;
    } else {
      $("#join-msg").textContent = (r && r.error) ? r.error : "Greška";
      if (window.__diag) __diag.push("Join fail: " + (r && r.error ? r.error : "unknown"));
    }
  })
  .catch(function(){ $("#join-msg").textContent = "Mrežna greška"; });
};

$("#btn-open-profile").onclick = function(){
  function afterMe(){
    $("#profile-email").textContent   = ME.email;
    $("#profile-balance").textContent = ME.balance + " čipova";
    $("#profile-avatar-preview").src  = ME.avatar || "/avatar_1.png";
    return safeFetch("/api/avatars")
      .then(function(r){ return r.json(); })
      .catch(function(){ return null; })
      .then(function(r){
        var grid = $("#avatar-grid");
        grid.innerHTML = "";
        var avatars = (r && r.avatars) ? r.avatars : [];
        for (var i=0;i<avatars.length;i++){
          (function(src){
            var img = document.createElement("img");
            img.className = "avatar";
            img.src = src;
            img.onclick = function(){
              safeFetch("/api/me/avatar",{
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({avatar:src})
              })
              .then(function(x){ return x.json(); })
              .then(function(rr){
                if (rr && rr.ok){
                  $("#profile-avatar-preview").src = src;
                  me().then(function(){
                    $("#profile-msg").textContent = "Avatar promijenjen.";
                  });
                } else {
                  $("#profile-msg").textContent = "Greška.";
                }
              })
              .catch(function(){ $("#profile-msg").textContent = "Mrežna greška"; });
            };
            grid.appendChild(img);
          })(avatars[i]);
        }
        $("#profile-box").style.display = "flex";
      });
  }
  if (!ME) { me().then(afterMe); } else { afterMe(); }
};
$("#btn-close-profile").onclick = function(){ $("#profile-box").style.display = "none"; };

/* ---------- WebSocket sa dijagnostikom ---------- */
function connectWS(){
  var proto = (location.protocol === "https:") ? "wss" : "ws";
  try{
    var ws = new WebSocket(proto + "://" + location.host);
    ws.onmessage = function(ev){
      try {
        var m = JSON.parse(ev.data);
        if (m && m.type === "lobby") loadTables();
      } catch(e){}
    };
    ws.onclose = function(){ setTimeout(connectWS, 1200); };
    ws.onerror = function(){ if (window.__diag) __diag.push("WebSocket error (možda blokiran na mreži)"); };
  }catch(err){
    if (window.__diag) __diag.push("WS init fail: " + (err && err.message ? err.message : err));
  }
}
connectWS();

/* ---------- Init ---------- */
(function init(){
  me().then(loadTables)
     .catch(function(e){ if (window.__diag) __diag.push("Init fail: " + e); });
})();
</script>
</body>
</html>
