<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>POKER</title>
<style>
  :root{
    --bg:#0c1117; --panel:#121826; --soft:#1b2436; --accent:#4b9cff; --ok:#3ecf8e; --bad:#ff6b6b; --text:#e8eef6;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 600px at 50% 0%, #101726, #0a0f17 60%, #05080e 100%);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1100px;margin:18px auto;padding:0 12px}
  .topbar{display:flex;align-items:center;justify-content:space-between;background:var(--panel);padding:10px 12px;border-radius:12px;border:1px solid #26324b}
  .muted{opacity:.7}
  button,.btn{background:#1e293b;border:1px solid #2f3e5e;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
  button:hover{filter:brightness(1.1)}
  input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2f3e5e;background:#111827;color:var(--text)}
  .grid{display:grid;gap:12px}
  .cols-2{grid-template-columns:1.2fr .8fr}
  .panel{background:var(--panel);border:1px solid #26324b;border-radius:14px;padding:12px}

  /* TABLE AREA */
  .tableWrap{position:relative;aspect-ratio:16/9;background:#09101c;border-radius:16px;border:1px solid #26324b;overflow:hidden}
  .felt{position:absolute;inset:0;background:url("poker_table.png") center/contain no-repeat, radial-gradient(200px 100px at 50% 50%, #144d3f, #0b2d25 60%, #071b16 100%)}
  .board{position:absolute;left:50%;top:36%;transform:translateX(-50%);display:flex;gap:8px}
  .card{width:56px;height:78px;border-radius:6px;background:#fff url("card_front_blank.png") center/cover no-repeat;box-shadow:0 2px 6px rgba(0,0,0,.5)}
  .seat{position:absolute;width:160px;padding:8px;border-radius:12px;background:rgba(10,16,28,.65);border:1px solid #2a3857;backdrop-filter: blur(2px)}
  .seat .name{font-weight:600}
  .seat .stack{opacity:.8}
  .seat .state{opacity:.6}
  .seat .badge{display:inline-block;padding:2px 6px;border-radius:8px;background:#25314d;margin-left:6px;font-size:12px}
  .acting{outline:2px solid #ffd166; box-shadow:0 0 0 4px rgba(255,209,102,.2)}
  .dealer{position:absolute;right:-10px;top:-10px;width:28px;height:28px;border-radius:50%;background:#fff url("dealer_button.png") center/75% no-repeat;box-shadow:0 2px 8px rgba(0,0,0,.6)}
  .pot{position:absolute;left:50%;top:47%;transform:translate(-50%,-50%);padding:6px 10px;border-radius:10px;background:#0f1729d9;border:1px solid #2a3857}

  /* SEAT POSITIONS (9-max) – centered around table image */
  /* index: 0 top-center, then clockwise like PokerStars layout */
  .s0{left:50%;top:6%;transform:translate(-50%,0)}
  .s1{right:9%;top:18%}
  .s2{right:2%;top:40%}
  .s3{right:10%;bottom:18%}
  .s4{left:50%;bottom:6%;transform:translate(-50%,0)}
  .s5{left:10%;bottom:18%}
  .s6{left:2%;top:40%}
  .s7{left:9%;top:18%}
  .s8{left:50%;top:22%;transform:translate(-50%,0)}

  /* RIGHT PANEL */
  .controls{display:grid;gap:10px}
  .row{display:flex;gap:8px}
  .row>.grow{flex:1}
  .big{font-size:18px;font-weight:700}
  .btn-ok{background:#134e4a;border-color:#175e58}
  .btn-bad{background:#5a1f25;border-color:#7a2b33}
  .btn-warn{background:#50340d;border-color:#6b4512}
  .note{font-size:12px;opacity:.8}
  hr{border:none;border-top:1px solid #26324b;margin:4px 0 10px}
  .pill{padding:4px 8px;border-radius:999px;background:#243049;border:1px solid #2e3d5d;display:inline-block}
  .hidden{display:none !important}
</style>
</head>
<body>
<div class="wrap">

  <div class="topbar">
    <div id="userBar" class="muted">Niste prijavljeni</div>
    <div class="row">
      <button id="btnShowLogin">Login</button>
      <button id="btnLogout" class="hidden">Logout</button>
    </div>
  </div>

  <div class="grid cols-2" style="margin-top:12px">
    <!-- LEFT: TABLE -->
    <div class="panel tableWrap">
      <div class="felt"></div>

      <div id="pot" class="pot hidden">Pot: 0s</div>
      <div id="board" class="board"></div>

      <!-- 9 seats -->
      <template id="seatTpl">
        <div class="seat">
          <div class="dealer hidden"></div>
          <div class="name">Seat</div>
          <div class="stack">Stack: 0g 0s</div>
          <div class="state muted">empty</div>
        </div>
      </template>
      <div id="seats"></div>
    </div>

    <!-- RIGHT: CONTROLS -->
    <div class="panel">
      <div id="tableHeader" class="row" style="align-items:center;justify-content:space-between">
        <div>
          <div class="big" id="tableName">–</div>
          <div class="muted" id="tableBlinds"></div>
        </div>
        <div><span id="tableStatus" class="pill">waiting</span></div>
      </div>
      <hr/>

      <div class="controls">
        <div class="row">
          <input id="buyinBB" class="grow" placeholder="Buy-in u BB (npr. 50)"/>
          <input id="seatIdx" style="width:120px" placeholder="Seat index (0-8)"/>
        </div>
        <div class="row">
          <button id="btnJoin">Join</button>
          <button id="btnRebuy">Rebuy</button>
          <button id="btnLeave" class="btn-bad">Leave</button>
        </div>

        <hr/>

        <div class="row">
          <button id="btnCheck">Check</button>
          <button id="btnCall">Call</button>
        </div>
        <div class="row">
          <input id="amountS" class="grow" placeholder="Iznos (silver) – npr. 200"/>
        </div>
        <div class="row">
          <button id="btnBet" class="btn-ok">Bet</button>
          <button id="btnRaise" class="btn-warn">Raise</button>
          <button id="btnFold" class="btn-bad">Fold</button>
          <button id="btnAllin" class="btn-bad">All-In</button>
        </div>

        <div class="note">
          • 1 gold = 100 silver • SB/BB su u silveru u backendu (npr. BB 200s = 2g) • Hand starta kad su min. 2 **occupied** igrača sa stackom.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- LOGIN MODAL -->
<div id="modal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center">
  <div class="panel" style="width:min(92vw,420px)">
    <div class="big">Login / Register</div>
    <div class="row" style="margin-top:10px"><input id="email" placeholder="Email"/></div>
    <div class="row"><input id="pass" type="password" placeholder="Password (min 6)"/></div>
    <div class="row" style="margin-top:8px">
      <button id="btnDoLogin" class="btn-ok">Login</button>
      <button id="btnDoRegister">Register</button>
      <button id="btnCloseModal" class="btn-bad" style="margin-left:auto">Close</button>
    </div>
    <div id="authMsg" class="note" style="margin-top:8px"></div>
  </div>
</div>

<script>
(() => {
  const API = "/api";
  const WSS = (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/";

  const el = sel => document.querySelector(sel);
  const $ = {
    userBar: el("#userBar"),
    btnShowLogin: el("#btnShowLogin"),
    btnLogout: el("#btnLogout"),
    modal: el("#modal"),
    email: el("#email"),
    pass: el("#pass"),
    btnDoLogin: el("#btnDoLogin"),
    btnDoRegister: el("#btnDoRegister"),
    btnCloseModal: el("#btnCloseModal"),
    authMsg: el("#authMsg"),

    tableName: el("#tableName"),
    tableBlinds: el("#tableBlinds"),
    tableStatus: el("#tableStatus"),
    seatsWrap: el("#seats"),
    seatTpl: document.getElementById("seatTpl"),
    board: el("#board"),
    pot: el("#pot"),

    buyinBB: el("#buyinBB"),
    seatIdx: el("#seatIdx"),
    amountS: el("#amountS"),
    btnJoin: el("#btnJoin"),
    btnRebuy: el("#btnRebuy"),
    btnLeave: el("#btnLeave"),
    btnCheck: el("#btnCheck"),
    btnCall: el("#btnCall"),
    btnBet: el("#btnBet"),
    btnRaise: el("#btnRaise"),
    btnFold: el("#btnFold"),
    btnAllin: el("#btnAllin"),
  };

  let ws = null;
  let me = null;
  let table = null;
  let seats = [];
  let actingSeat = null;
  let lastState = null;

  // -------- Auth helpers --------
  async function api(path, init={}){
    const res = await fetch(API + path, { credentials:"include", ...init });
    const data = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(data?.error || ("HTTP "+res.status));
    return data;
  }
  async function refreshMe(){
    try{
      const r = await api("/me");
      me = r.user;
      $.userBar.innerHTML = `${me.email}  &nbsp; <span class="muted">Chips: ${Math.floor(me.gold||0)}g ${(me.silver||0)}s</span>`;
      $.btnShowLogin.classList.add("hidden");
      $.btnLogout.classList.remove("hidden");
    }catch{
      me = null;
      $.userBar.textContent = "Niste prijavljeni";
      $.btnShowLogin.classList.remove("hidden");
      $.btnLogout.classList.add("hidden");
    }
  }

  // -------- UI helpers --------
  function gs(s){ return `${Math.floor((s|0)/100)}g ${(s|0)%100}s`; }
  function renderSeats(){
    $.seatsWrap.innerHTML = "";
    for (let i=0;i<(table?.seats||9);i++){
      const tpl = $.seatTpl.content.firstElementChild.cloneNode(true);
      tpl.classList.add("s"+i);
      const data = seats.find(r => r.seat_index===i);
      const name = tpl.querySelector(".name");
      const stack = tpl.querySelector(".stack");
      const state = tpl.querySelector(".state");
      const dealer = tpl.querySelector(".dealer");
      if (data){
        name.textContent = `Seat ${i}` + (data.user_id ? (me && data.user_id===me.id ? " (YOU)" : "") : "");
        stack.textContent = `Stack: ${gs(data.stack_s)}`;
        state.textContent = `State: ${data.state}${data.in_hand? " (in hand)": ""}`;
      } else {
        name.textContent = `Seat ${i}`;
        stack.textContent = `Stack: 0g 0s`;
        state.textContent = `empty`;
      }
      // dealer button
      if (lastState && (i===lastState.btn_seat)) dealer.classList.remove("hidden");
      // acting highlight
      if (actingSeat===i) tpl.classList.add("acting");
      $.seatsWrap.appendChild(tpl);
    }
  }
  function renderBoard(cardsCsv){
    $.board.innerHTML = "";
    const arr = (cardsCsv||"").split(",").filter(Boolean);
    for (const _ of arr){
      const c = document.createElement("div");
      c.className = "card";
      $.board.appendChild(c);
    }
  }

  // -------- WebSocket --------
  function connectWS(){
    if (ws && (ws.readyState===1 || ws.readyState===0)) return;
    ws = new WebSocket(WSS);
    ws.addEventListener("open", ()=> { /* OK */ });
    ws.addEventListener("message", (ev)=>{
      let msg; try{ msg=JSON.parse(ev.data); }catch{ return; }
      const t = msg?.type;
      if (t==="connection_open"){ /* uid available */ }
      if (t==="lobby_update"){ /* ignore for now */ }
      if (t==="table_state"){
        table = msg.table; seats = msg.seats||[];
        $.tableName.textContent = `${table.name}`;
        $.tableBlinds.textContent = `Blinds: ${Math.floor(table.sb_s/100)}g / ${Math.floor(table.bb_s/100)}g`;
        $.tableStatus.textContent = (table.status||"waiting");
        renderSeats();
      }
      if (t==="action_required"){
        actingSeat = msg.seat_index;
        renderSeats();
      }
      if (t==="board_update"){
        renderBoard((msg.board||[]).join(","));
      }
      if (t==="showdown"){
        $.pot.classList.add("hidden");
        renderBoard((msg.board||[]).join(","));
      }
      if (t==="payouts"){
        $.pot.classList.add("hidden");
      }
      if (t==="error"){
        alert(msg.message || msg.code || "Action error");
      }
    });
    ws.addEventListener("close", ()=> setTimeout(connectWS, 1200));
  }

  // -------- Actions --------
  function sendAction(action, amount_s){
    if (!ws || ws.readyState!==1) return alert("WS not connected");
    if (!table){ return; }
    // nađi moju stolicu
    const mySeat = seats.find(s=> s.user_id=== (me?.id||-1));
    if (!mySeat){ return alert("Nisi za stolom"); }
    ws.send(JSON.stringify({
      type:"player_action",
      payload:{
        table_id: table.id,
        seat_index: mySeat.seat_index,
        action,
        amount_s: Number(amount_s||0)
      }
    }));
  }

  // -------- Events --------
  $.btnShowLogin.onclick = ()=> $.modal.classList.remove("hidden");
  $.btnCloseModal.onclick = ()=> $.modal.classList.add("hidden");
  $.btnDoLogin.onclick = async ()=>{
    try{
      $.authMsg.textContent = "";
      await api("/login", {method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify({email:$.email.value, password:$.pass.value})});
      $.modal.classList.add("hidden");
      await refreshMe();
      connectWS();
      // refresh table state
      const st = await api("/poker/table/1/state");
      table = st.table; seats = st.seats||[]; lastState = st.hand;
      renderSeats(); renderBoard(st.hand?.board || "");
    }catch(e){ $.authMsg.textContent = "Login fail: " + e.message; }
  };
  $.btnDoRegister.onclick = async ()=>{
    try{
      $.authMsg.textContent = "";
      await api("/register", {method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify({email:$.email.value, password:$.pass.value})});
      $.authMsg.textContent = "OK – sada klikni Login.";
    }catch(e){ $.authMsg.textContent = "Register fail: " + e.message; }
  };
  $.btnLogout.onclick = async ()=>{ try{ await api("/logout"); }catch{}; await refreshMe(); };

  $.btnJoin.onclick = async ()=>{
    try{
      const bb = Number($.buyinBB.value||0);
      const seat_index = $.seatIdx.value==="" ? undefined : Number($.seatIdx.value);
      const body = seat_index===undefined ? { buyin_bb: bb } : { buyin_bb: bb, seat_index };
      await api("/poker/table/1/join",{method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      const st = await api("/poker/table/1/state"); table = st.table; seats = st.seats||[]; lastState = st.hand; renderSeats();
    }catch(e){ alert(e.message||"Join failed"); }
  };
  $.btnRebuy.onclick = async ()=>{
    try{
      const bb = Number($.buyinBB.value||0);
      await api("/poker/table/1/rebuy",{method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify({ buyin_bb: bb })});
    }catch(e){ alert(e.message||"Rebuy failed"); }
  };
  $.btnLeave.onclick = async ()=>{
    try{
      await api("/poker/table/1/leave",{method:"POST"});
    }catch(e){ alert(e.message||"Leave failed"); }
  };

  $.btnCheck.onclick = ()=> sendAction("check");
  $.btnCall.onclick = ()=> sendAction("call");
  $.btnBet.onclick  = ()=> sendAction("bet",   Number($.amountS.value||0));
  $.btnRaise.onclick= ()=> sendAction("raise", Number($.amountS.value||0));
  $.btnFold.onclick = ()=> sendAction("fold");
  $.btnAllin.onclick= ()=> sendAction("allin", 999999999);

  // -------- Boot --------
  (async () => {
    await refreshMe();
    connectWS();
    try{
      const st = await api("/poker/table/1/state");
      table = st.table; seats = st.seats||[]; lastState = st.hand;
      $.tableName.textContent = table.name;
      $.tableBlinds.textContent = `Blinds: ${Math.floor(table.sb_s/100)}g / ${Math.floor(table.bb_s/100)}g`;
      $.tableStatus.textContent = table.status || "waiting";
      renderSeats(); renderBoard(st.hand?.board || "");
    }catch{}
  })();
})();
</script>
</body>
</html>
