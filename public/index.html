<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Texas Hold’em</title>

  <link rel="preload" as="image" href="/poker_table.png">
  <link rel="preload" as="image" href="/seat_empty.png">
  <link rel="preload" as="image" href="/card_front_blank.png">
  <link rel="preload" as="image" href="/kard_bach.png">

  <link rel="stylesheet" href="/game.css">
</head>
<body>

<!-- Topbar -->
<div id="topbar" class="hidden">
  <div id="info-pill" class="pill">—</div>
  <button id="btn-open-join" class="pill btn hidden" type="button">Join</button>
  <button id="btn-leave" class="pill btn hidden" type="button">Napusti</button>
</div>

<!-- Auth modal -->
<div id="auth-box" class="modal-backdrop" style="display:flex">
  <div class="modal">
    <div style="font-weight:800;color:#94a3b8">Prijava / Registracija</div>
    <div class="row"><input id="email" type="email" placeholder="Email"></div>
    <div class="row"><input id="pass" type="password" placeholder="Lozinka"></div>
    <div class="row"><input id="nick" type="text" placeholder="Nickname (samo za registraciju)" maxlength="24"></div>
    <div class="row">
      <select id="avatar">
        <option value="/avatar_1.png">avatar_1</option>
        <option value="/avatar_2.png">avatar_2</option>
        <option value="/avatar_3.png">avatar_3</option>
        <option value="/avatar_4.png">avatar_4</option>
        <option value="/avatar_5.png">avatar_5</option>
        <option value="/avatar_7.png">avatar_7</option>
        <option value="/avatar_8.png">avatar_8</option>
      </select>
    </div>
    <div class="row">
      <button id="btn-login" type="button">Login</button>
      <button class="secondary" id="btn-register" type="button">Registracija</button>
    </div>
    <div id="auth-msg" class="muted"></div>
  </div>
</div>

<!-- Lobby -->
<div class="wrap" id="lobby" style="display:none">
  <h1 style="margin:0 0 12px 0;">Texas Hold’em — Lobby</h1>
  <div class="tabs">
    <button class="tab active" data-tab="mali">Mali sto (0.2 / 0.5 KM)</button>
    <button class="tab" data-tab="veliki">Veliki sto (1 / 2 KM)</button>
  </div>

  <section id="sec-mali" class="section active">
    <div class="card">
      <div class="meta">
        <h3>⭐ Mali sto — 9-max</h3>
        <div class="muted">Blindovi: <b>0.2 / 0.5 KM</b> · Buy-in: <b>50–100 BB</b></div>
      </div>
      <div class="grid" style="min-width:300px">
        <div class="kpi"><b>9</b><span class="muted">sjedišta</span></div>
        <div class="kpi"><b>0.2 / 0.5</b><span class="muted">SB / BB (KM)</span></div>
        <div class="kpi"><b>50–100BB</b><span class="muted">buy-in</span></div>
      </div>
      <button class="btn" id="join-small" type="button">Uđi</button>
    </div>
  </section>

  <section id="sec-veliki" class="section">
    <div class="card">
      <div class="meta">
        <h3>🔥 Veliki sto — 9-max</h3>
        <div class="muted">Blindovi: <b>1 / 2 KM</b> · Buy-in: <b>50–100 BB</b></div>
      </div>
      <div class="grid" style="min-width:300px">
        <div class="kpi"><b>9</b><span class="muted">sjedišta</span></div>
        <div class="kpi"><b>1 / 2</b><span class="muted">SB / BB (KM)</span></div>
        <div class="kpi"><b>50–100BB</b><span class="muted">buy-in</span></div>
      </div>
      <button class="btn" id="join-big" type="button">Uđi</button>
    </div>
  </section>
</div>

<!-- Table Stage -->
<div class="wrap" id="stage" style="display:none">
  <div id="table" role="application" aria-label="Texas Hold’em table">
    <div id="pot">—</div>
    <div id="board"></div>
    <div id="status">Spreman</div>

    <!-- Seats -->
    <div id="seats">
      <!-- 9 slotova -->
      <!-- puni ih JS, ali HTML ovdje radi layout -->
      <div class="seat" data-i="0"><img class="avatar" src="/seat_empty.png" alt=""><div class="nick"></div><div class="stack"></div><div class="badges"></div></div>
      <div class="seat" data-i="1"><img class="avatar" src="/seat_empty.png" alt=""><div class="nick"></div><div class="stack"></div><div class="badges"></div></div>
      <div class="seat" data-i="2"><img class="avatar" src="/seat_empty.png" alt=""><div class="nick"></div><div class="stack"></div><div class="badges"></div></div>
      <div class="seat" data-i="3"><img class="avatar" src="/seat_empty.png" alt=""><div class="nick"></div><div class="stack"></div><div class="badges"></div></div>
      <div class="seat" data-i="4"><img class="avatar" src="/seat_empty.png" alt=""><div class="nick"></div><div class="stack"></div><div class="badges"></div></div>
      <div class="seat" data-i="5"><img class="avatar" src="/seat_empty.png" alt=""><div class="nick"></div><div class="stack"></div><div class="badges"></div></div>
      <div class="seat" data-i="6"><img class="avatar" src="/seat_empty.png" alt=""><div class="nick"></div><div class="stack"></div><div class="badges"></div></div>
      <div class="seat" data-i="7"><img class="avatar" src="/seat_empty.png" alt=""><div class="nick"></div><div class="stack"></div><div class="badges"></div></div>
      <div class="seat" data-i="8"><img class="avatar" src="/seat_empty.png" alt=""><div class="nick"></div><div class="stack"></div><div class="badges"></div></div>
    </div>

    <!-- Join modal -->
    <div id="join-box" class="modal-backdrop">
      <div class="modal">
        <div style="font-weight:800;color:#94a3b8">Join <span id="join-table-name"></span></div>
        <label for="join-seat">Sjedalo</label>
        <select id="join-seat"></select>
        <label for="join-buy">Buy-in (KM)</label>
        <input id="join-buy" type="number" min="1" step="0.01" value="0" inputmode="decimal">
        <div id="join-range" class="muted">—</div>
        <div class="row">
          <button id="btn-join-confirm" type="button">Join</button>
          <button class="secondary" id="btn-join-cancel" type="button">Zatvori</button>
        </div>
        <div id="join-msg" class="muted"></div>
      </div>
    </div>

    <!-- Action buttons (za engine kasnije) -->
    <div id="actions" class="hidden">
      <button id="btn-fold"  type="button" class="danger"   disabled>Fold</button>
      <button id="btn-check" type="button" class="secondary" disabled>Check</button>
      <button id="btn-call"  type="button" class="secondary" disabled>Call</button>
      <button id="btn-bet"   type="button"                  disabled>Bet/Raise</button>
    </div>
  </div>
</div>

<script>
const $  = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
function fmtKM(x){ return (Math.round(x*100)/100).toFixed(2) + " KM"; }

// Tabs
const tabs = $$(".tab");
tabs.forEach(t=>t.addEventListener("click", ()=>{
  tabs.forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  const key = t.dataset.tab;
  $("#sec-mali").classList.toggle("active", key==="mali");
  $("#sec-veliki").classList.toggle("active", key==="veliki");
}));

// Auth
const authBox = $("#auth-box");
async function api(path, body){
  const r = await fetch(path,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body||{})});
  return r.json();
}
$("#btn-login").onclick = async ()=>{
  const j = await api("/api/auth/login",{ email:$("#email").value.trim(), password:$("#pass").value });
  if(!j.ok){ $("#auth-msg").textContent = j.error||"Greška"; return; }
  authBox.style.display = "none";
  $("#lobby").style.display = "";
  connectWS();
};
$("#btn-register").onclick = async ()=>{
  const j = await api("/api/auth/register",{
    email: $("#email").value.trim(),
    password: $("#pass").value,
    nick: $("#nick").value.trim(),
    avatar: $("#avatar").value
  });
  if(!j.ok){ $("#auth-msg").textContent = j.error||"Greška"; return; }
  authBox.style.display = "none";
  $("#lobby").style.display = "";
  connectWS();
};

// WS
let WS = null;
let currentTable = null;
let selectedTableId = null;
function connectWS(){
  const proto = location.protocol === "https:" ? "wss" : "ws";
  WS = new WebSocket(`${proto}://${location.host}/ws`);
  WS.addEventListener("message", (ev)=>{
    const msg = JSON.parse(ev.data);
    if (msg.type === "hello"){ /* lobby visible */ }
    if (msg.type === "selected"){
      currentTable = msg.table;
      showStage();
      renderTable(msg.table);
    }
    if (msg.type === "state"){
      if (!currentTable || msg.table.id === currentTable.id){
        currentTable = msg.table;
        renderTable(msg.table);
      }
    }
    if (msg.type === "error"){
      alert(msg.msg);
    }
  });
}

$("#join-small").onclick = ()=> selectTable("small");
$("#join-big").onclick   = ()=> selectTable("big");

function selectTable(id){
  selectedTableId = id;
  WS?.send(JSON.stringify({ type:"selectTable", tableId:id }));
}

function showStage(){
  $("#lobby").style.display = "none";
  $("#stage").style.display = "";
  $("#topbar").classList.remove("hidden");
  $("#btn-open-join").classList.remove("hidden");
  $("#btn-leave").classList.remove("hidden");
}

// Join modal
const joinBox = $("#join-box");
$("#btn-open-join").onclick = ()=>{
  if(!currentTable) return;
  $("#join-table-name").textContent = currentTable.name;
  const min = currentTable.bb*currentTable.minBB;
  const max = currentTable.bb*currentTable.maxBB;
  $("#join-range").textContent = `${currentTable.minBB}–${currentTable.maxBB}BB (${fmtKM(min)} – ${fmtKM(max)})`;
  $("#join-buy").value = Math.round(((min+max)/2)*100)/100;

  const sel = $("#join-seat"); sel.innerHTML="";
  currentTable.seats.forEach((s,i)=>{ if(!s){ const o=document.createElement("option"); o.value=String(i); o.textContent=`Sjedalo ${i+1}`; sel.appendChild(o); }});
  joinBox.style.display = "flex";
};
$("#btn-join-cancel").onclick = ()=> joinBox.style.display = "none";
$("#btn-join-confirm").onclick = ()=>{
  const seatIndex = parseInt($("#join-seat").value || "0", 10);
  const buyinKM = parseFloat($("#join-buy").value || "0");
  WS?.send(JSON.stringify({ type:"join", tableId:selectedTableId, seatIndex, buyinKM }));
  joinBox.style.display = "none";
};
$("#btn-leave").onclick = ()=> WS?.send(JSON.stringify({ type:"leave" }));

// Render
function renderTable(t){
  $("#info-pill").textContent = `${t.name} • ${t.sb} / ${t.bb} ${t.currency}`;
  // seats
  $$("#seats .seat").forEach(n=>{
    const i = parseInt(n.dataset.i,10);
    const s = t.seats[i];
    const ava = n.querySelector(".avatar");
    const nick= n.querySelector(".nick");
    const stack=n.querySelector(".stack");
    const badges=n.querySelector(".badges");
    if (s){
      ava.src = s.avatar||"/avatar_1.png";
      nick.innerHTML = `<b>${s.nick||"Igrač"}</b>`;
      stack.textContent = fmtKM(s.stack||0);
      badges.innerHTML = "";
      if (i === t.dealer){
        const d = document.createElement("span");
        d.className = "badge img dealer";
        d.innerHTML = '<img alt="D">';
        badges.appendChild(d);
      }
    } else {
      ava.src = "/seat_empty.png";
      nick.innerHTML = '<button class="free">SLOBODNO</button>';
      stack.textContent = "";
      badges.innerHTML = "";
      // klik na SLOBODNO otvara join s tim seatom
      const btn = n.querySelector(".free");
      btn.onclick = ()=>{
        $("#btn-open-join").click();
        // izlistani su samo slobodni, pa se već pojavi
        $("#join-seat").value = String(i);
      };
    }
  });

  // pot / board (engine kasnije)
  $("#board").innerHTML = "";
  $("#pot").textContent = t.pot > 0 ? fmtKM(t.pot) : "—";
  $("#status").textContent = "Spreman";
}

// inicijalno pozicioniraj seatove (9-max elipsa)
(function positionSeats(){
  const pos = [
    { left:"50%", top:"86%" },
    { left:"72%", top:"79%" },
    { left:"86%", top:"60%" },
    { left:"84%", top:"36%" },
    { left:"68%", top:"18%" },
    { left:"32%", top:"18%" },
    { left:"16%", top:"36%" },
    { left:"14%", top:"60%" },
    { left:"28%", top:"79%" }
  ];
  $$("#seats .seat").forEach(n=>{
    const i=parseInt(n.dataset.i,10);
    n.style.left = pos[i].left;
    n.style.top  = pos[i].top;
  });
})();
</script>
</body>
</html>
